<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paguyuban Simpan Pinjam</title>
<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; line-height: 1.5; }
header { background: #2563eb; color: #fff; padding: 16px; display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
header img { width: 48px; height: 48px; border-radius: 8px; background: #fff; object-fit: cover; }
.container { max-width: 800px; margin: 0 auto; padding: 16px; }
.card { background: #fff; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.menu-item { display: flex; gap: 12px; align-items: center; padding: 14px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s; }
.menu-item:hover { background: #f9fafb; }
.menu-item:last-child { border: none; }
.menu-icon { font-size: 24px; }
.menu-text { font-size: 15px; font-weight: 600; color: #374151; }
.hidden { display: none !important; }

input, select, button {
  width: 100%;
  padding: 12px 16px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  font-family: inherit;
}
button {
  background: #2563eb;
  color: #fff;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
button:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); }
button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }

.btn-secondary { background: #6b7280; }
.btn-secondary:hover { background: #4b5563; }
.btn-success { background: #10b981; }
.btn-success:hover { background: #059669; }
.btn-danger { background: #ef4444; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: #f59e0b; color: #000; }
.btn-warning:hover { background: #d97706; }
.btn-info { background: #3b82f6; }
.btn-info:hover { background: #2563eb; }
.btn-purple { background: #8b5cf6; }
.btn-purple:hover { background: #7c3aed; }
.btn-small { padding: 6px 12px; font-size: 12px; width: auto; margin: 2px; }

.table-wrap { overflow-x: auto; margin-top: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
table { width: 100%; border-collapse: collapse; background: #fff; font-size: 13px; }
thead { background: #2563eb; color: #fff; }
th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
tbody tr:hover { background: #f9fafb; }

.badge { padding: 4px 10px; border-radius: 9999px; font-size: 11px; font-weight: 600; display: inline-block; }
.badge-wait { background: #fef3c7; color: #92400e; }
.badge-ok { background: #d1fae5; color: #065f46; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-info { background: #dbeafe; color: #1e40af; }

.loading {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}
.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid #fff;
  border-top-color: #2563eb;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.login-box {
  max-width: 420px;
  margin: 40px auto;
  padding: 32px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
.login-title { text-align: center; color: #1f2937; margin-bottom: 24px; font-size: 24px; }
.alert {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 13px;
}
.alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
.alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }

.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 9999px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 16px;
}
.status-online { background: #d1fae5; color: #065f46; }
.status-offline { background: #fee2e2; color: #991b1b; }
.status-checking { background: #dbeafe; color: #1e40af; }

.config-section {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-top: 20px;
}
.config-section h4 { margin: 0 0 12px 0; color: #4b5563; font-size: 14px; }

.divider {
  display: flex;
  align-items: center;
  margin: 20px 0;
  color: #6b7280;
  font-size: 13px;
}
.divider::before, .divider::after {
  content: "";
  flex: 1;
  height: 1px;
  background: #e5e7eb;
}
.divider span { padding: 0 12px; }

.mode-badge {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 8px 16px;
  border-radius: 9999px;
  font-size: 12px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 100;
}
.mode-demo { background: #fef3c7; color: #92400e; }
.mode-live { background: #d1fae5; color: #065f46; }

.empty-state { text-align: center; padding: 40px; color: #6b7280; }
.empty-state-icon { font-size: 48px; margin-bottom: 16px; }

.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 4px; }

h3 { margin-top: 0; color: #1f2937; }
.mt-4 { margin-top: 16px; }
.flex { display: flex; }
.gap-2 { gap: 8px; }

/* Style untuk kolom total iuran */
.total-iuran {
  font-weight: bold;
  color: #059669;
  background: #d1fae5;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
}

/* Watermark style */
.watermark {
  text-align: center;
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
  color: #9ca3af;
  font-size: 11px;
  font-style: italic;
}

/* Style untuk search dan filter */
.search-box {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.stat-value {
  font-size: 20px;
  font-weight: bold;
  color: #2563eb;
}

.stat-label {
  font-size: 11px;
  color: #6b7280;
  margin-top: 4px;
}

.detail-card {
  background: #f9fafb;
  border-left: 4px solid #2563eb;
  padding: 16px;
  margin-bottom: 16px;
  border-radius: 0 8px 8px 0;
}

.detail-title {
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  font-size: 14px;
}

.detail-content {
  color: #6b7280;
  font-size: 13px;
}

.activity-list {
  max-height: 300px;
  overflow-y: auto;
}

.activity-item {
  padding: 10px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 13px;
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-date {
  color: #9ca3af;
  font-size: 11px;
}

/* Filter section styles */
.filter-section {
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}

.filter-grid .form-group {
  margin-bottom: 0;
}

.filter-grid label {
  font-size: 12px;
  color: #0369a1;
}

.filter-grid input, .filter-grid select {
  margin-top: 4px;
  padding: 8px 12px;
  font-size: 13px;
}

/* Summary box styles */
.summary-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
}

.summary-item {
  text-align: center;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
}

.summary-value {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 4px;
}

.summary-label {
  font-size: 12px;
  opacity: 0.9;
}

/* Grand total styles */
.grand-total {
  background: #f0fdf4;
  border: 2px solid #10b981;
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  text-align: center;
}

.grand-total-value {
  font-size: 32px;
  font-weight: bold;
  color: #059669;
}

.grand-total-label {
  font-size: 14px;
  color: #6b7280;
  margin-top: 8px;
}

/* Dashboard cards */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.dashboard-card {
  color: #fff;
  padding: 20px;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
}

.dashboard-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
}

.dashboard-card-title {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.dashboard-card-value {
  font-size: 28px;
  font-weight: bold;
  position: relative;
  z-index: 1;
}

/* Pengembalian iuran styles */
.refund-card {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.refund-info {
  background: #fff;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.refund-info-title {
  font-weight: 600;
  color: #374151;
  margin-bottom: 12px;
  font-size: 16px;
}

.refund-detail {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.refund-detail-item {
  background: #f9fafb;
  padding: 12px;
  border-radius: 8px;
}

.refund-detail-label {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

.refund-detail-value {
  font-size: 16px;
  font-weight: bold;
  color: #1f2937;
}

.refund-highlight {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-top: 16px;
}

.refund-highlight-value {
  font-size: 36px;
  font-weight: bold;
  color: #92400e;
}

.refund-highlight-label {
  font-size: 14px;
  color: #92400e;
  margin-top: 8px;
}

/* Status anggota */
.status-aktif { color: #059669; font-weight: 600; }
.status-keluar { color: #dc2626; font-weight: 600; }

@media(max-width: 640px) {
  .container { padding: 12px; }
  .login-box { margin: 20px; padding: 20px; }
  .filter-grid {
    grid-template-columns: 1fr;
  }
  .refund-detail {
    grid-template-columns: 1fr;
  }
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<div id="loading" class="loading hidden"><div class="spinner"></div></div>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-box">
    <h2 class="login-title">üè¶ Paguyuban Simpan Pinjam</h2>
    
    <div id="connectionStatus" class="status-pill status-checking">
      <span>‚è≥</span> Memeriksa koneksi...
    </div>
    
    <div id="alerts"></div>
    
    <div id="quickActions">
      <button class="btn-success" onclick="startDemo()" style="margin-bottom: 8px;">
        üöÄ Mulai Mode Demo (Cepat)
      </button>
      <p style="text-align: center; color: #6b7280; font-size: 12px; margin: 8px 0;">
        Mode demo tidak perlu login, data tersimpan di browser
      </p>
    </div>
    
    <div class="divider"><span>ATAU</span></div>
    
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" placeholder="email@contoh.com" value="naningsetyorini28@gmail.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button onclick="doLogin()">Login dengan Supabase</button>
    
    <div class="config-section">
      <h4>‚öôÔ∏è Konfigurasi Database</h4>
      <div class="form-group">
        <label>Supabase URL</label>
        <input type="text" id="sbUrl" value="https://xqscatmkwzpollfloxwu.supabase.co">
      </div>
      <div class="form-group">
        <label>Anon Key</label>
        <input type="text" id="sbKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxc2NhdG1rd3pwb2xsZmxveHd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjQ3NTQsImV4cCI6MjA4NTgwMDc1NH0.BPy_JoR_hrhVHxviHxAuv_8CF5ZyzrvXkp872UecwHU">
      </div>
      <div class="flex gap-2">
        <button class="btn-secondary" onclick="saveConfig()" style="flex: 1;">Simpan</button>
        <button class="btn-warning" onclick="testConnection()" style="flex: 1;">Test Koneksi</button>
      </div>
    </div>
    
    <!-- WATERMARK - Created & Developed by D.D Candra -->
    <div class="watermark">
      Created & Developed by <strong>D.D Candra</strong>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden">
  <header>
    <img id="logoImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%232563eb' rx='20' width='100' height='100'/%3E%3Ctext x='50' y='65' font-size='45' text-anchor='middle' fill='white'%3Eüè¶%3C/text%3E%3C/svg%3E">
    <div style="flex: 1;">
      <h3 style="margin: 0; font-size: 18px;" id="appTitle">Paguyuban</h3>
      <small style="opacity: 0.9;" id="appSubtitle">Simpan Pinjam</small>
    </div>
    <div style="text-align: right;">
      <small id="userInfo" style="display: block; font-size: 11px;"></small>
      <small id="modeInfo" style="font-size: 10px; opacity: 0.8;"></small>
    </div>
  </header>
  
  <div class="container">
    <!-- MENU -->
    <div id="menu" class="card">
      <div class="menu-item" onclick="navigate('dashboard')">
        <span class="menu-icon">üìä</span>
        <span class="menu-text">Dashboard</span>
      </div>
      <div class="menu-item" onclick="navigate('anggota')">
        <span class="menu-icon">üë•</span>
        <span class="menu-text">Data Anggota</span>
      </div>
      <div class="menu-item" onclick="navigate('pengajuan')">
        <span class="menu-icon">üìù</span>
        <span class="menu-text">Pengajuan Pinjaman</span>
      </div>
      <div class="menu-item" onclick="navigate('pencairan')">
        <span class="menu-icon">üí∞</span>
        <span class="menu-text">Pencairan</span>
      </div>
      <div class="menu-item" onclick="navigate('angsuran')">
        <span class="menu-icon">üíµ</span>
        <span class="menu-text">Pembayaran Angsuran</span>
      </div>
      <div class="menu-item" onclick="navigate('iuran')">
        <span class="menu-icon">üîÑ</span>
        <span class="menu-text">Iuran Rutin</span>
      </div>
      <div class="menu-item" onclick="navigate('pengembalian')">
        <span class="menu-icon">üí∏</span>
        <span class="menu-text">Pengembalian Iuran</span>
      </div>
      <div class="menu-item" onclick="navigate('saldo')">
        <span class="menu-icon">üí≥</span>
        <span class="menu-text">Manajemen Saldo</span>
      </div>
      <div class="menu-item" onclick="navigate('laporan')">
        <span class="menu-icon">üìÑ</span>
        <span class="menu-text">Laporan</span>
      </div>
      <div class="menu-item" onclick="navigate('pengaturan')">
        <span class="menu-icon">‚öôÔ∏è</span>
        <span class="menu-text">Pengaturan</span>
      </div>
      <button class="btn-secondary" onclick="doLogout()" style="margin-top: 8px;">Logout</button>
    </div>
    
    <!-- DASHBOARD -->
    <div id="dashboard" class="card hidden">
      <h3>üìä Dashboard</h3>
      <div class="dashboard-grid">
        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div class="dashboard-card-title">Saldo Kas</div>
          <div class="dashboard-card-value" id="dashKas">Rp 0</div>
        </div>
        <div class="dashboard-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <div class="dashboard-card-title">Total Piutang</div>
          <div class="dashboard-card-value" id="dashPiutang">Rp 0</div>
        </div>
        <div class="dashboard-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
          <div class="dashboard-card-title">Jumlah Anggota Aktif</div>
          <div class="dashboard-card-value" id="dashAnggota">0</div>
        </div>
        <div class="dashboard-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
          <div class="dashboard-card-title">Total Iuran Terkumpul</div>
          <div class="dashboard-card-value" id="dashTotalIuran">Rp 0</div>
        </div>
        <div class="dashboard-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
          <div class="dashboard-card-title">Total Angsuran Masuk</div>
          <div class="dashboard-card-value" id="dashTotalAngsuran">Rp 0</div>
        </div>
        <div class="dashboard-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #374151;">
          <div class="dashboard-card-title">Total Pengembalian Iuran</div>
          <div class="dashboard-card-value" id="dashTotalPengembalian">Rp 0</div>
        </div>
      </div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 20px;">Kembali</button>
    </div>
    
    <!-- ANGGOTA -->
    <div id="anggota" class="card hidden">
      <h3>üë• Data Anggota</h3>
      
      <!-- Statistik Anggota -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statTotalAnggota">0</div>
          <div class="stat-label">Total Anggota</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statAnggotaAktif">0</div>
          <div class="stat-label">Anggota Aktif</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statAnggotaKeluar">0</div>
          <div class="stat-label">Anggota Keluar</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotalIuran">Rp 0</div>
          <div class="stat-label">Total Iuran Masuk</div>
        </div>
      </div>
      
      <!-- Search Anggota -->
      <div class="form-group">
        <label>Cari Anggota (Lihat Detail Aktivitas)</label>
        <input type="text" id="searchAnggota" class="search-box" placeholder="Ketik nama anggota..." oninput="searchAnggotaDetail()">
      </div>
      
      <!-- Detail Anggota Container -->
      <div id="detailAnggotaContainer" class="hidden">
        <div class="detail-card">
          <div class="detail-title" id="detailNamaAnggota">Detail Anggota</div>
          <div id="detailContent"></div>
          <div class="flex gap-2" style="margin-top: 12px;">
            <button onclick="downloadDetailPDF()" class="btn-success" style="flex: 1;">üì• Download PDF</button>
            <button onclick="prosesPengembalianFromDetail()" class="btn-purple" style="flex: 1;">üí∏ Proses Pengembalian Iuran</button>
          </div>
        </div>
      </div>
      
      <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">
      
      <h4>Tambah/Edit Anggota</h4>
      <div class="form-group">
        <label>Nama Lengkap</label>
        <input id="aggNama" placeholder="Masukkan nama">
      </div>
      <div class="form-group">
        <label>Tanggal Masuk</label>
        <input type="date" id="aggTanggal">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="aggStatus">
          <option value="AKTIF">Aktif</option>
          <option value="KELUAR">Keluar</option>
        </select>
      </div>
      <div class="form-group" id="aggKeluarContainer" style="display: none;">
        <label>Tanggal Keluar</label>
        <input type="date" id="aggTanggalKeluar">
      </div>
      <input type="hidden" id="aggId">
      <div class="flex gap-2">
        <button onclick="saveAnggota()" style="flex: 1;">Simpan</button>
        <button class="btn-secondary" onclick="resetAnggotaForm()" style="flex: 1;">Reset</button>
      </div>
      
      <div id="aggList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- PENGAJUAN -->
    <div id="pengajuan" class="card hidden">
      <h3>üìù Pengajuan Pinjaman</h3>
      <div class="form-group">
        <label>Nama Anggota</label>
        <select id="pjAnggota"><option value="">Pilih Anggota</option></select>
      </div>
      <div class="form-group">
        <label>Nominal Pinjaman (Rp)</label>
        <input type="number" id="pjNominal" placeholder="1000000">
      </div>
      <div class="form-group">
        <label>Tenor (bulan)</label>
        <select id="pjTenor">
          <option value="">Pilih tenor</option>
          <option value="1">1 bulan</option>
          <option value="2">2 bulan</option>
          <option value="3">3 bulan</option>
          <option value="4">4 bulan</option>
          <option value="5">5 bulan</option>
          <option value="6">6 bulan</option>
          <option value="7">7 bulan</option>
          <option value="8">8 bulan</option>
          <option value="9">9 bulan</option>
          <option value="10">10 bulan</option>
          <option value="11">11 bulan</option>
          <option value="12">12 bulan</option>
        </select>
      </div>
      <input type="hidden" id="pjId">
      <div class="flex gap-2">
        <button onclick="savePengajuan()" style="flex: 1;">Simpan Pengajuan</button>
        <button class="btn-secondary" onclick="resetPengajuanForm()" style="flex: 1;">Reset</button>
      </div>
      
      <div id="pjList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- PENCAIRAN -->
    <div id="pencairan" class="card hidden">
      <h3>üí∞ Pencairan Pinjaman</h3>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4 style="margin-top: 0; color: #0369a1; font-size: 14px;">üîç Filter Pencairan</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label>Nama Anggota</label>
            <select id="filterCairNama" onchange="applyFilterPencairan()">
              <option value="">Semua Anggota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bulan</label>
            <input type="month" id="filterCairBulan" onchange="applyFilterPencairan()">
          </div>
          <div class="form-group">
            <label>Tanggal Spesifik</label>
            <input type="date" id="filterCairTanggal" onchange="applyFilterPencairan()">
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-secondary" onclick="resetFilterPencairan()" style="width: auto; padding: 8px 16px; font-size: 12px;">Reset Filter</button>
        </div>
      </div>
      
      <div id="cairList"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- ANGSURAN -->
    <div id="angsuran" class="card hidden">
      <h3>üíµ Pembayaran Angsuran</h3>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4 style="margin-top: 0; color: #0369a1; font-size: 14px;">üîç Filter Angsuran</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label>Nama Anggota</label>
            <select id="filterAngsuranNama" onchange="applyFilterAngsuran()">
              <option value="">Semua Anggota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bulan</label>
            <input type="month" id="filterAngsuranBulan" onchange="applyFilterAngsuran()">
          </div>
          <div class="form-group">
            <label>Tanggal Spesifik</label>
            <input type="date" id="filterAngsuranTanggal" onchange="applyFilterAngsuran()">
          </div>
          <div class="form-group">
            <label>Minggu Ke</label>
            <select id="filterAngsuranMinggu" onchange="applyFilterAngsuran()">
              <option value="">Semua Minggu</option>
              <option value="1">Minggu 1</option>
              <option value="2">Minggu 2</option>
              <option value="3">Minggu 3</option>
              <option value="4">Minggu 4</option>
            </select>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-secondary" onclick="resetFilterAngsuran()" style="width: auto; padding: 8px 16px; font-size: 12px;">Reset Filter</button>
        </div>
      </div>
      
      <!-- Total Angsuran -->
      <div id="totalAngsuranContainer" class="grand-total hidden">
        <div class="grand-total-value" id="totalAngsuranValue">Rp 0</div>
        <div class="grand-total-label">Total Angsuran Masuk (sesuai filter)</div>
      </div>
      
      <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">
      
      <h4>Tambah/Edit Angsuran</h4>
      <div class="form-group">
        <label>Nama Anggota</label>
        <select id="angAnggota" onchange="calcSisa()"><option value="">Pilih Anggota</option></select>
      </div>
      <div class="form-group">
        <label>Nominal Angsuran (Rp)</label>
        <input type="number" id="angNominal" placeholder="0" oninput="calcSisa()">
      </div>
      <div class="form-group">
        <label>Angsuran Ke-</label>
        <input type="number" id="angKe" placeholder="1">
      </div>
      <div class="form-group">
        <label>Sisa Setelah Bayar</label>
        <input type="text" id="angSisa" readonly placeholder="Pilih anggota dan masukkan nominal">
      </div>
      <input type="hidden" id="angId">
      <div class="flex gap-2">
        <button onclick="saveAngsuran()" style="flex: 1;">Simpan Angsuran</button>
        <button class="btn-secondary" onclick="resetAngsuranForm()" style="flex: 1;">Reset</button>
      </div>
      
      <div id="angList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- IURAN -->
    <div id="iuran" class="card hidden">
      <h3>üîÑ Iuran Rutin</h3>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4 style="margin-top: 0; color: #0369a1; font-size: 14px;">üîç Filter Iuran</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label>Nama Anggota</label>
            <select id="filterIuranNama" onchange="applyFilterIuran()">
              <option value="">Semua Anggota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bulan</label>
            <input type="month" id="filterIuranBulan" onchange="applyFilterIuran()">
          </div>
          <div class="form-group">
            <label>Tanggal Spesifik</label>
            <input type="date" id="filterIuranTanggal" onchange="applyFilterIuran()">
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-secondary" onclick="resetFilterIuran()" style="width: auto; padding: 8px 16px; font-size: 12px;">Reset Filter</button>
        </div>
      </div>
      
      <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">
      
      <h4>Tambah/Edit Iuran</h4>
      <div class="form-group">
        <label>Nama Anggota</label>
        <select id="iurAnggota"><option value="">Pilih Anggota</option></select>
      </div>
      <div class="form-group">
        <label>Nominal Iuran (Rp)</label>
        <input type="number" id="iurNominal" placeholder="50000">
      </div>
      <div class="form-group">
        <label>Periode (Bulan-Tahun)</label>
        <input type="month" id="iurBulan">
      </div>
      <input type="hidden" id="iurId">
      <div class="flex gap-2">
        <button onclick="saveIuran()" style="flex: 1;">Simpan Iuran</button>
        <button class="btn-secondary" onclick="resetIuranForm()" style="flex: 1;">Reset</button>
      </div>
      
      <div id="iurList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- PENGEMBALIAN IURAN -->
    <div id="pengembalian" class="card hidden">
      <h3>üí∏ Pengembalian Iuran (Anggota Keluar)</h3>
      
      <div class="refund-card">
        <h4 style="margin-top: 0; font-size: 16px;">‚ÑπÔ∏è Informasi Pengembalian Iuran</h4>
        <p style="margin: 8px 0; font-size: 13px; opacity: 0.95;">
          Fitur ini digunakan untuk mengembalikan iuran kepada anggota yang berhenti/keluar dari paguyuban.
          Perhitungan otomatis dari tanggal masuk sampai tanggal keluar.
        </p>
      </div>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4 style="margin-top: 0; color: #0369a1; font-size: 14px;">üîç Filter Pengembalian</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label>Nama Anggota</label>
            <select id="filterRefundNama" onchange="applyFilterRefund()">
              <option value="">Semua Anggota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bulan</label>
            <input type="month" id="filterRefundBulan" onchange="applyFilterRefund()">
          </div>
          <div class="form-group">
            <label>Tanggal Spesifik</label>
            <input type="date" id="filterRefundTanggal" onchange="applyFilterRefund()">
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-secondary" onclick="resetFilterRefund()" style="width: auto; padding: 8px 16px; font-size: 12px;">Reset Filter</button>
        </div>
      </div>
      
      <!-- Total Pengembalian -->
      <div id="totalRefundContainer" class="refund-highlight hidden">
        <div class="refund-highlight-value" id="totalRefundValue">Rp 0</div>
        <div class="refund-highlight-label">Total Pengembalian Iuran (sesuai filter)</div>
      </div>
      
      <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">
      
      <h4>Proses Pengembalian Iuran</h4>
      <div class="form-group">
        <label>Pilih Anggota (Yang Sudah Keluar)</label>
        <select id="refundAnggota" onchange="hitungRefundOtomatis()">
          <option value="">Pilih Anggota</option>
        </select>
      </div>
      
      <!-- Info Perhitungan -->
      <div id="refundInfoContainer" class="refund-info hidden">
        <div class="refund-info-title">üìä Perhitungan Pengembalian Iuran</div>
        <div class="refund-detail">
          <div class="refund-detail-item">
            <div class="refund-detail-label">Tanggal Masuk</div>
            <div class="refund-detail-value" id="refundTanggalMasuk">-</div>
          </div>
          <div class="refund-detail-item">
            <div class="refund-detail-label">Tanggal Keluar</div>
            <div class="refund-detail-value" id="refundTanggalKeluar">-</div>
          </div>
          <div class="refund-detail-item">
            <div class="refund-detail-label">Lama Keanggotaan</div>
            <div class="refund-detail-value" id="refundLamaBulan">-</div>
          </div>
          <div class="refund-detail-item">
            <div class="refund-detail-label">Total Iuran Masuk</div>
            <div class="refund-detail-value" id="refundTotalIuranMasuk">Rp 0</div>
          </div>
        </div>
        
        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 16px; text-align: center;">
          <div style="font-size: 12px; color: #92400e; margin-bottom: 4px;">Total Pengembalian Iuran</div>
          <div style="font-size: 28px; font-weight: bold; color: #92400e;" id="refundTotalDisplay">Rp 0</div>
          <div style="font-size: 11px; color: #92400e; margin-top: 4px;">100% dari total iuran yang sudah masuk</div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Nominal Pengembalian (Rp)</label>
        <input type="number" id="refundNominal" placeholder="0">
      </div>
      <div class="form-group">
        <label>Tanggal Pengembalian</label>
        <input type="date" id="refundTanggal">
      </div>
      <div class="form-group">
        <label>Keterangan</label>
        <input type="text" id="refundKeterangan" placeholder="Pengembalian iuran anggota keluar">
      </div>
      <input type="hidden" id="refundId">
      <div class="flex gap-2">
        <button onclick="saveRefund()" style="flex: 1;">üí∏ Proses Pengembalian</button>
        <button class="btn-secondary" onclick="resetRefundForm()" style="flex: 1;">Reset</button>
      </div>
      
      <div id="refundList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- SALDO MANAJEMEN -->
    <div id="saldo" class="card hidden">
      <h3>üí≥ Manajemen Saldo</h3>
      
      <!-- Summary Box -->
      <div class="summary-box">
        <h4 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">üìä Ringkasan Transaksi Kas</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-value" id="summaryDebet">Rp 0</div>
            <div class="summary-label">Total Debet (Masuk)</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryKredit">Rp 0</div>
            <div class="summary-label">Total Kredit (Keluar)</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryTransaksi">0</div>
            <div class="summary-label">Jumlah Transaksi</div>
          </div>
          <div class="summary-item" style="background: rgba(255,255,255,0.2);">
            <div class="summary-value" id="saldoTotal">Rp 0</div>
            <div class="summary-label">Saldo Saat Ini</div>
          </div>
        </div>
      </div>
      
      <h4>Tambah/Edit Saldo</h4>
      <div class="form-group">
        <label>Jenis Transaksi</label>
        <select id="saldoJenis">
          <option value="DEBET">Debet (Masuk)</option>
          <option value="KREDIT">Kredit (Keluar)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nominal (Rp)</label>
        <input type="number" id="saldoNominal" placeholder="0">
      </div>
      <div class="form-group">
        <label>Keterangan</label>
        <input type="text" id="saldoKeterangan" placeholder="Keterangan transaksi">
      </div>
      <div class="form-group">
        <label>Tanggal</label>
        <input type="date" id="saldoTanggal">
      </div>
      <input type="hidden" id="saldoId">
      <div class="flex gap-2">
        <button onclick="saveSaldo()" style="flex: 1;">Simpan</button>
        <button class="btn-secondary" onclick="resetSaldoForm()" style="flex: 1;">Reset</button>
      </div>
      
      <h4 style="margin-top: 24px;">Riwayat Transaksi Saldo</h4>
      <div id="saldoList" class="mt-4"></div>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- LAPORAN -->
    <div id="laporan" class="card hidden">
      <h3>üìÑ Laporan Rekening Koran</h3>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <h4 style="margin-top: 0; color: #0369a1; font-size: 14px;">üîç Filter Laporan</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label>Nama Anggota</label>
            <select id="filterLapNama" onchange="previewLaporan()">
              <option value="">Semua Anggota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="filterLapTanggal" onchange="previewLaporan()">
          </div>
          <div class="form-group">
            <label>Minggu Ke</label>
            <select id="filterLapMinggu" onchange="previewLaporan()">
              <option value="">Semua Minggu</option>
              <option value="1">Minggu 1</option>
              <option value="2">Minggu 2</option>
              <option value="3">Minggu 3</option>
              <option value="4">Minggu 4</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bulan</label>
            <input type="month" id="filterLapBulan" onchange="previewLaporan()">
          </div>
          <div class="form-group">
            <label>Tahun</label>
            <select id="filterLapTahun" onchange="previewLaporan()">
              <option value="">Semua Tahun</option>
            </select>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="btn-secondary" onclick="resetFilterLaporan()" style="width: auto; padding: 8px 16px; font-size: 12px;">Reset Filter</button>
          <button class="btn-success" onclick="downloadReport()" style="width: auto; padding: 8px 16px; font-size: 12px;">üì• Download PDF</button>
        </div>
      </div>
      
      <!-- Preview Laporan -->
      <div id="laporanPreview" style="margin-top: 20px;">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>Pilih filter untuk melihat preview laporan</p>
        </div>
      </div>
      
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 16px;">Kembali</button>
    </div>
    
    <!-- PENGATURAN -->
    <div id="pengaturan" class="card hidden">
      <h3>‚öôÔ∏è Pengaturan</h3>
      <div class="form-group">
        <label>Nama Aplikasi</label>
        <input id="setNama" placeholder="Paguyuban Simpan Pinjam">
      </div>
      <div class="form-group">
        <label>Tagline/Subjudul</label>
        <input id="setTagline" placeholder="Tanpa Bunga ‚Ä¢ Kekeluargaan">
      </div>
      <div class="form-group">
        <label>Alamat/Institusi</label>
        <input id="setAlamat" placeholder="Politeknik Negeri Madura">
      </div>
      <div class="form-group">
        <label>Logo Aplikasi</label>
        <input type="file" id="setLogo" accept="image/*" onchange="previewLogo(this)">
        <img id="logoPreview" style="max-width: 100px; margin-top: 10px; display: none;">
      </div>
      <div class="flex gap-2">
        <button onclick="saveSettings()" style="flex: 1;">Simpan Pengaturan</button>
        <button class="btn-secondary" onclick="resetSettingsForm()" style="flex: 1;">Reset</button>
      </div>
      <button onclick="exportData()" class="btn-secondary" style="margin-top: 8px;">üíæ Export Data (JSON)</button>
      <button class="btn-secondary" onclick="backToMenu()" style="margin-top: 8px;">Kembali</button>
    </div>
  </div>
</div>

<div id="modeBadge" class="mode-badge mode-demo hidden">DEMO MODE</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ==========================================
// KONFIGURASI & VARIABEL GLOBAL
// ==========================================
var SB_URL = 'https://xqscatmkwzpollfloxwu.supabase.co';
var SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhxc2NhdG1rd3pwb2xsZmxveHd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjQ3NTQsImV4cCI6MjA4NTgwMDc1NH0.BPy_JoR_hrhVHxviHxAuv_8CF5ZyzrvXkp872UecwHU';

var sbClient = null;
var isDemoMode = false;
var currentUser = null;
var currentDetailAnggota = null;

var appData = {
  anggota: [],
  pengajuan: [],
  pinjaman: [],
  angsuran: [],
  iuran: [],
  kas: [],
  refund: [], // Data pengembalian iuran
  settings: { 
    nama: 'Paguyuban Simpan Pinjam', 
    tagline: 'Tanpa Bunga ‚Ä¢ Kekeluargaan',
    alamat: 'Politeknik Negeri Madura',
    logo: null
  }
};

// Variabel untuk filter
var filterPencairan = { nama: '', bulan: '', tanggal: '' };
var filterIuran = { nama: '', bulan: '', tanggal: '' };
var filterAngsuran = { nama: '', bulan: '', tanggal: '', minggu: '' };
var filterLaporan = { nama: '', tanggal: '', minggu: '', bulan: '', tahun: '' };
var filterRefund = { nama: '', bulan: '', tanggal: '' };

// ==========================================
// INISIALISASI
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
  var savedUrl = localStorage.getItem('sb_url');
  var savedKey = localStorage.getItem('sb_key');
  if (savedUrl) SB_URL = savedUrl;
  if (savedKey) SB_KEY = savedKey;
  
  document.getElementById('sbUrl').value = SB_URL;
  document.getElementById('sbKey').value = SB_KEY;
  
  // Load settings from localStorage first
  loadSettingsFromStorage();
  
  // Populate tahun filter
  populateTahunFilter();
  
  // Setup event listener untuk status anggota
  document.getElementById('aggStatus').addEventListener('change', function() {
    var container = document.getElementById('aggKeluarContainer');
    if (this.value === 'KELUAR') {
      container.style.display = 'block';
      document.getElementById('aggTanggalKeluar').value = new Date().toISOString().split('T')[0];
    } else {
      container.style.display = 'none';
      document.getElementById('aggTanggalKeluar').value = '';
    }
  });
  
  initSupabase();
  setTimeout(checkConnection, 1000);
});

function populateTahunFilter() {
  var select = document.getElementById('filterLapTahun');
  var currentYear = new Date().getFullYear();
  for (var i = currentYear; i >= currentYear - 5; i--) {
    var option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    select.appendChild(option);
  }
}

function loadSettingsFromStorage() {
  var savedSettings = localStorage.getItem('paguyuban_settings');
  if (savedSettings) {
    try {
      var parsed = JSON.parse(savedSettings);
      Object.assign(appData.settings, parsed);
    } catch (e) {
      console.error('Failed to load settings:', e);
    }
  }
}

function initSupabase() {
  try {
    if (window.supabase && window.supabase.createClient) {
      sbClient = window.supabase.createClient(SB_URL, SB_KEY);
      console.log('Supabase client created');
    } else {
      console.error('Supabase library not loaded');
      showStatus('offline', 'Library tidak tersedia');
    }
  } catch (e) {
    console.error('Init error:', e);
    showStatus('offline', 'Error init');
  }
}

// ==========================================
// KONEKSI & STATUS
// ==========================================
async function checkConnection() {
  var statusEl = document.getElementById('connectionStatus');
  
  if (!sbClient) {
    statusEl.className = 'status-pill status-offline';
    statusEl.innerHTML = '<span>‚ùå</span> Supabase tidak siap';
    return;
  }
  
  statusEl.className = 'status-pill status-checking';
  statusEl.innerHTML = '<span>‚è≥</span> Testing...';
  
  try {
    var timeout = new Promise(function(_, reject) {
      setTimeout(function() { reject(new Error('Timeout')); }, 8000);
    });
    
    var test = sbClient.from('anggota').select('count', { count: 'exact', head: true });
    var result = await Promise.race([test, timeout]);
    
    if (result.error) throw result.error;
    
    statusEl.className = 'status-pill status-online';
    statusEl.innerHTML = '<span>‚úÖ</span> Terhubung';
    showAlert('Koneksi berhasil!', 'success');
    
  } catch (err) {
    console.error('Connection error:', err);
    statusEl.className = 'status-pill status-offline';
    
    var msg = 'Gagal terhubung';
    if (err.message && err.message.includes('Failed to fetch')) {
      msg = 'Tidak ada koneksi internet';
    } else if (err.message && err.message.includes('JWT')) {
      msg = 'API Key invalid';
    } else if (err.message === 'Timeout') {
      msg = 'Koneksi timeout';
    }
    
    statusEl.innerHTML = '<span>‚ö†Ô∏è</span> ' + msg;
    showAlert(msg + '. Gunakan Mode Demo.', 'warning');
  }
}

function showStatus(type, text) {
  var el = document.getElementById('connectionStatus');
  el.className = 'status-pill status-' + type;
  var icon = type === 'online' ? '‚úÖ' : type === 'offline' ? '‚ùå' : '‚è≥';
  el.innerHTML = '<span>' + icon + '</span> ' + text;
}

function showAlert(msg, type) {
  var alerts = document.getElementById('alerts');
  var div = document.createElement('div');
  div.className = 'alert alert-' + type;
  div.textContent = msg;
  alerts.appendChild(div);
  setTimeout(function() { div.remove(); }, 5000);
}

function showLoading(show) {
  document.getElementById('loading').classList.toggle('hidden', !show);
}

// ==========================================
// KONFIGURASI
// ==========================================
function saveConfig() {
  SB_URL = document.getElementById('sbUrl').value.trim();
  SB_KEY = document.getElementById('sbKey').value.trim();
  
  localStorage.setItem('sb_url', SB_URL);
  localStorage.setItem('sb_key', SB_KEY);
  
  initSupabase();
  showAlert('Konfigurasi disimpan!', 'success');
  setTimeout(checkConnection, 500);
}

function testConnection() {
  showAlert('Testing koneksi...', 'info');
  checkConnection();
}

// ==========================================
// AUTHENTICATION
// ==========================================
async function doLogin() {
  var email = document.getElementById('email').value.trim();
  var pass = document.getElementById('password').value;
  
  if (!email || !pass) {
    showAlert('Email dan password wajib diisi!', 'error');
    return;
  }
  
  if (!sbClient) {
    showAlert('Supabase belum siap!', 'error');
    return;
  }
  
  showLoading(true);
  
  try {
    var result = await sbClient.auth.signInWithPassword({ email: email, password: pass });
    showLoading(false);
    
    if (result.error) {
      showAlert('Login gagal: ' + result.error.message, 'error');
      return;
    }
    
    currentUser = result.data.user;
    isDemoMode = false;
    enterApp();
    
  } catch (e) {
    showLoading(false);
    showAlert('Error: ' + e.message, 'error');
  }
}

function startDemo() {
  isDemoMode = true;
  currentUser = { email: 'demo@local', id: 'demo' };
  
  var saved = localStorage.getItem('paguyuban_demo');
  if (saved) {
    try {
      var parsed = JSON.parse(saved);
      Object.assign(appData, parsed);
    } catch (e) {
      console.error('Failed to load demo data');
    }
  }
  
  enterApp();
  showAlert('Mode Demo aktif!', 'success');
}

function enterApp() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  
  if (isDemoMode) {
    document.getElementById('modeBadge').classList.remove('hidden');
    document.getElementById('userInfo').textContent = 'Demo User';
    document.getElementById('modeInfo').textContent = 'Data lokal';
  } else {
    document.getElementById('userInfo').textContent = currentUser.email;
    document.getElementById('modeInfo').textContent = 'Supabase Cloud';
    loadFromSupabase();
  }
  
  updateDashboard();
  updateHeaderSettings();
}

function updateHeaderSettings() {
  // Update header dengan settings yang tersimpan
  document.getElementById('appTitle').textContent = appData.settings.nama || 'Paguyuban';
  document.getElementById('appSubtitle').textContent = appData.settings.tagline || 'Simpan Pinjam';
  
  if (appData.settings.logo) {
    document.getElementById('logoImg').src = appData.settings.logo;
  }
}

function doLogout() {
  if (isDemoMode) {
    localStorage.setItem('paguyuban_demo', JSON.stringify(appData));
  }
  
  isDemoMode = false;
  currentUser = null;
  
  if (sbClient) sbClient.auth.signOut();
  
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('modeBadge').classList.add('hidden');
  document.getElementById('alerts').innerHTML = '';
  
  appData = {
    anggota: [], pengajuan: [], pinjaman: [],
    angsuran: [], iuran: [], kas: [], refund: [],
    settings: { 
      nama: 'Paguyuban Simpan Pinjam', 
      tagline: 'Tanpa Bunga ‚Ä¢ Kekeluargaan',
      alamat: 'Politeknik Negeri Madura',
      logo: null
    }
  };
}

// ==========================================
// DATA OPERATIONS
// ==========================================
async function loadFromSupabase() {
  showLoading(true);
  try {
    var results = await Promise.all([
      sbClient.from('anggota').select('*'),
      sbClient.from('pengajuan').select('*'),
      sbClient.from('pinjaman').select('*'),
      sbClient.from('angsuran').select('*'),
      sbClient.from('iuran').select('*'),
      sbClient.from('kas').select('*'),
      sbClient.from('refund').select('*'), // Load pengembalian iuran
      sbClient.from('setting').select('*').eq('key', 'app').single()
    ]);
    
    appData.anggota = results[0].data || [];
    appData.pengajuan = results[1].data || [];
    appData.pinjaman = results[2].data || [];
    appData.angsuran = results[3].data || [];
    appData.iuran = results[4].data || [];
    appData.kas = results[5].data || [];
    appData.refund = results[6].data || [];
    
    if (results[7].data && results[7].data.value) {
      Object.assign(appData.settings, results[7].data.value);
      localStorage.setItem('paguyuban_settings', JSON.stringify(appData.settings));
      updateHeaderSettings();
    }
    
  } catch (e) {
    console.error('Load error:', e);
    showAlert('Gagal memuat data', 'warning');
  }
  showLoading(false);
}

function saveDemoData() {
  if (isDemoMode) {
    localStorage.setItem('paguyuban_demo', JSON.stringify(appData));
  }
}

// ==========================================
// NAVIGATION
// ==========================================
function navigate(page) {
  document.getElementById('menu').classList.add('hidden');
  document.querySelectorAll('#mainApp .card').forEach(function(c) {
    if (c.id !== 'menu') c.classList.add('hidden');
  });
  document.getElementById(page).classList.remove('hidden');
  renderPage(page);
}

function backToMenu() {
  document.querySelectorAll('#mainApp .card').forEach(function(c) {
    c.classList.add('hidden');
  });
  document.getElementById('menu').classList.remove('hidden');
  currentDetailAnggota = null;
  document.getElementById('detailAnggotaContainer').classList.add('hidden');
  document.getElementById('searchAnggota').value = '';
}

// ==========================================
// HELPER: HITUNG TOTAL IURAN ANGGOTA
// ==========================================
function getTotalIuranAnggota(namaAnggota) {
  return appData.iuran
    .filter(function(i) { return i.anggota === namaAnggota; })
    .reduce(function(total, i) { return total + (i.nominal || 0); }, 0);
}

// ==========================================
// HELPER: HITUNG LAMA KEANGGOTAAN (INKLUSIF)
// Bulan bergabung dihitung sebagai bulan ke-1
// ==========================================
function hitungLamaBulan(masukDate, keluarDate) {
  if (!masukDate) return { text: '-', bulan: 0, sudahSatuBulan: false };
  
  var masuk = new Date(masukDate);
  var today = keluarDate ? new Date(keluarDate) : new Date();
  
  // Reset time to compare dates only
  masuk.setHours(0, 0, 0, 0);
  today.setHours(0, 0, 0, 0);
  
  // Hitung selisih tahun dan bulan
  var years = today.getFullYear() - masuk.getFullYear();
  var months = today.getMonth() - masuk.getMonth();
  
  // Total bulan matematis (belum ditambah inklusif)
  var rawMonths = years * 12 + months;
  
  // LOGIKA INKLUSIF: Bulan bergabung selalu dihitung sebagai bulan ke-1
  // Jadi selalu tambah 1 untuk menghitung bulan bergabung itu sendiri
  var totalMonths = rawMonths + 1;
  
  // Jika tanggal hari ini belum mencapai tanggal masuk, kurangi 1
  // Karena belum selesai 1 bulan penuh dari tanggal masuk bulan ini
  if (today.getDate() < masuk.getDate()) {
    totalMonths = totalMonths - 1;
  }
  
  // Pastikan minimal 1 bulan (jika sudah masuk)
  if (totalMonths < 1) totalMonths = 1;
  
  // Format text
  var parts = [];
  
  if (totalMonths >= 12) {
    var y = Math.floor(totalMonths / 12);
    var m = totalMonths % 12;
    parts.push(y + ' th');
    if (m > 0) {
      parts.push(m + ' bln');
    }
  } else {
    parts.push(totalMonths + ' bln');
  }
  
  var text = parts.join(' ');
  
  return {
    text: text,
    bulan: totalMonths, // Total bulan inklusif
    sudahSatuBulan: totalMonths >= 1,
    totalBulan: totalMonths
  };
}

// ==========================================
// RENDER
// ==========================================
function updateDashboard() {
  document.getElementById('appTitle').textContent = appData.settings.nama;
  document.getElementById('appSubtitle').textContent = appData.settings.tagline;
  
  var kas = appData.kas.reduce(function(a, b) {
    return a + (b.jenis === 'DEBET' ? b.nominal : -b.nominal);
  }, 0);
  
  var piutang = appData.pinjaman.reduce(function(a, b) {
    return a + b.sisa;
  }, 0);
  
  // Hitung total semua iuran
  var totalIuran = appData.iuran.reduce(function(a, b) {
    return a + (b.nominal || 0);
  }, 0);
  
  // Hitung total angsuran masuk
  var totalAngsuran = appData.angsuran.reduce(function(a, b) {
    return a + (b.nominal || 0);
  }, 0);
  
  // Hitung total pengembalian iuran
  var totalPengembalian = appData.refund.reduce(function(a, b) {
    return a + (b.nominal || 0);
  }, 0);
  
  // Hitung anggota aktif (yang statusnya tidak KELUAR)
  var anggotaAktif = appData.anggota.filter(function(a) {
    return a.status !== 'KELUAR';
  }).length;
  
  document.getElementById('dashKas').textContent = 'Rp ' + kas.toLocaleString('id-ID');
  document.getElementById('dashPiutang').textContent = 'Rp ' + piutang.toLocaleString('id-ID');
  document.getElementById('dashAnggota').textContent = anggotaAktif;
  document.getElementById('dashTotalIuran').textContent = 'Rp ' + totalIuran.toLocaleString('id-ID');
  document.getElementById('dashTotalAngsuran').textContent = 'Rp ' + totalAngsuran.toLocaleString('id-ID');
  document.getElementById('dashTotalPengembalian').textContent = 'Rp ' + totalPengembalian.toLocaleString('id-ID');
}

function renderPage(page) {
  updateDashboard();
  
  if (page === 'anggota') renderAnggota();
  else if (page === 'pengajuan') renderPengajuan();
  else if (page === 'pencairan') renderPencairan();
  else if (page === 'angsuran') renderAngsuran();
  else if (page === 'iuran') renderIuran();
  else if (page === 'pengembalian') renderRefund();
  else if (page === 'saldo') renderSaldo();
  else if (page === 'pengaturan') renderSettings();
  else if (page === 'laporan') renderLaporan();
}

function renderAnggota() {
  // Update statistik
  var totalAnggota = appData.anggota.length;
  var anggotaAktif = appData.anggota.filter(function(a) { return a.status !== 'KELUAR'; }).length;
  var anggotaKeluar = appData.anggota.filter(function(a) { return a.status === 'KELUAR'; }).length;
  var totalIuran = appData.iuran.reduce(function(a, b) { return a + (b.nominal || 0); }, 0);
  
  document.getElementById('statTotalAnggota').textContent = totalAnggota;
  document.getElementById('statAnggotaAktif').textContent = anggotaAktif;
  document.getElementById('statAnggotaKeluar').textContent = anggotaKeluar;
  document.getElementById('statTotalIuran').textContent = 'Rp ' + totalIuran.toLocaleString('id-ID');
  
  var list = document.getElementById('aggList');
  if (!appData.anggota.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>Belum ada anggota</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Nama</th><th>Masuk</th><th>Status</th><th>Lama</th><th>Total Iuran</th><th>Aksi</th></tr></thead><tbody>';
  
  appData.anggota.forEach(function(a) {
    var tgl = a.masuk ? new Date(a.masuk).toLocaleDateString('id-ID') : '-';
    
    // Gunakan fungsi hitungLamaBulan yang baru (INKLUSIF)
    var lamaInfo = hitungLamaBulan(a.masuk, a.tanggal_keluar);
    var lamaText = lamaInfo.text;
    
    // Hitung total iuran untuk anggota ini
    var totalIuranAnggota = getTotalIuranAnggota(a.nama);
    
    // Status badge
    var statusBadge = '';
    if (a.status === 'KELUAR') {
      statusBadge = '<span class="badge badge-danger">KELUAR</span>';
    } else {
      // Tambahkan indikator jika sudah wajib iuran
      var wajibIuran = lamaInfo.sudahSatuBulan ? '<span class="badge badge-ok" style="margin-left: 4px;">Wajib Iuran</span>' : '<span class="badge badge-wait" style="margin-left: 4px;">Gratis</span>';
      statusBadge = '<span class="badge badge-ok">AKTIF</span>' + wajibIuran;
    }
    
    html += '<tr><td><strong>' + a.nama + '</strong></td><td>' + tgl + '</td><td>' + statusBadge + '</td><td>' + lamaText + '</td><td><span class="total-iuran">Rp ' + totalIuranAnggota.toLocaleString('id-ID') + '</span></td><td>' +
      '<button class="btn-small btn-warning" onclick="editAnggota(\'' + a.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deleteAnggota(\'' + a.id + '\')">Hapus</button>' +
      (a.status !== 'KELUAR' ? '<button class="btn-small btn-purple" onclick="setAnggotaKeluar(\'' + a.id + '\')">Set Keluar</button>' : '') +
      '</td></tr>';
  });
  
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

// ==========================================
// SEARCH & DETAIL ANGGOTA
// ==========================================
function searchAnggotaDetail() {
  var searchTerm = document.getElementById('searchAnggota').value.toLowerCase().trim();
  var container = document.getElementById('detailAnggotaContainer');
  
  if (!searchTerm) {
    container.classList.add('hidden');
    currentDetailAnggota = null;
    return;
  }
  
  var anggota = appData.anggota.find(function(a) {
    return a.nama.toLowerCase().includes(searchTerm);
  });
  
  if (!anggota) {
    container.classList.remove('hidden');
    document.getElementById('detailNamaAnggota').textContent = 'Anggota tidak ditemukan';
    document.getElementById('detailContent').innerHTML = '<p>Tidak ada data untuk "' + searchTerm + '"</p>';
    currentDetailAnggota = null;
    return;
  }
  
  currentDetailAnggota = anggota;
  showDetailAnggota(anggota);
}

function showDetailAnggota(anggota) {
  var container = document.getElementById('detailAnggotaContainer');
  container.classList.remove('hidden');
  document.getElementById('detailNamaAnggota').textContent = 'Detail: ' + anggota.nama;
  
  // Hitung data anggota
  var totalIuran = getTotalIuranAnggota(anggota.nama);
  
  var pinjamanAktif = appData.pinjaman.filter(function(p) {
    return p.anggota === anggota.nama && p.sisa > 0;
  });
  
  var sisaHutang = pinjamanAktif.reduce(function(sum, p) {
    return sum + p.sisa;
  }, 0);
  
  var totalPinjaman = appData.pinjaman
    .filter(function(p) { return p.anggota === anggota.nama; })
    .reduce(function(sum, p) { return sum + p.nominal; }, 0);
  
  var angsuranList = appData.angsuran.filter(function(a) {
    return a.anggota === anggota.nama;
  });
  
  var pengajuanList = appData.pengajuan.filter(function(p) {
    return p.anggota === anggota.nama;
  });
  
  // Cek apakah sudah ada pengembalian iuran
  var refundData = appData.refund.find(function(r) { return r.anggota === anggota.nama; });
  var sudahRefund = !!refundData;
  
  // Format tanggal bergabung
  var tglBergabung = anggota.masuk ? 
    new Date(anggota.masuk).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 
    'Tidak tercatat';
  
  // Info lama keanggotaan dengan sistem INKLUSIF
  var lamaInfo = hitungLamaBulan(anggota.masuk, anggota.tanggal_keluar);
  var statusIuran = lamaInfo.sudahSatuBulan ? 
    '<span class="badge badge-ok">Sudah Wajib Iuran</span>' : 
    '<span class="badge badge-wait">Belum Wajib Iuran (Gratis)</span>';
  
  // Status anggota
  var statusAnggota = anggota.status === 'KELUAR' ? 
    '<span class="badge badge-danger">KELUAR</span>' : 
    '<span class="badge badge-ok">AKTIF</span>';
  
  var html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">';
  html += '<div class="stat-card"><div class="stat-value" style="color: #059669;">Rp ' + totalIuran.toLocaleString('id-ID') + '</div><div class="stat-label">Total Iuran</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color: #dc2626;">Rp ' + sisaHutang.toLocaleString('id-ID') + '</div><div class="stat-label">Sisa Hutang</div></div>';
  html += '<div class="stat-card"><div class="stat-value">Rp ' + totalPinjaman.toLocaleString('id-ID') + '</div><div class="stat-label">Total Pinjaman</div></div>';
  html += '<div class="stat-card"><div class="stat-value">' + angsuranList.length + '</div><div class="stat-label">Total Angsuran</div></div>';
  html += '</div>';
  
  html += '<div class="detail-content">';
  html += '<p><strong>Status:</strong> ' + statusAnggota + '</p>';
  html += '<p><strong>üìÖ Bergabung:</strong> ' + tglBergabung + '</p>';
  if (anggota.status === 'KELUAR' && anggota.tanggal_keluar) {
    html += '<p><strong>üìÖ Keluar:</strong> ' + new Date(anggota.tanggal_keluar).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
  }
  html += '<p><strong>‚è±Ô∏è Lama:</strong> ' + lamaInfo.text + ' ' + statusIuran + '</p>';
  
  if (sudahRefund) {
    html += '<div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin: 12px 0;">';
    html += '<strong>üí∏ Sudah Diproses Pengembalian Iuran:</strong> Rp ' + refundData.nominal.toLocaleString('id-ID');
    html += '<br><small>Tanggal: ' + new Date(refundData.tanggal).toLocaleDateString('id-ID') + '</small>';
    html += '</div>';
  }
  
  // Riwayat Pinjaman
  html += '<h4 style="margin-top: 16px; color: #374151;">üìã Riwayat Pinjaman</h4>';
  if (pinjamanAktif.length === 0 && totalPinjaman === 0) {
    html += '<p>Tidak ada riwayat pinjaman</p>';
  } else {
    html += '<div class="activity-list">';
    appData.pinjaman.filter(function(p) { return p.anggota === anggota.nama; }).forEach(function(p) {
      var status = p.sisa > 0 ? '<span class="badge badge-wait">Berjalan</span>' : '<span class="badge badge-ok">Lunas</span>';
      html += '<div class="activity-item">';
      html += '<div>Pinjaman Rp ' + p.nominal.toLocaleString('id-ID') + ' ' + status + '</div>';
      html += '<div class="activity-date">Angsuran: Rp ' + p.angsuran.toLocaleString('id-ID') + '/bulan | Sisa: Rp ' + p.sisa.toLocaleString('id-ID') + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }
  
  // Riwayat Angsuran
  html += '<h4 style="margin-top: 16px; color: #374151;">üíµ Riwayat Pembayaran Angsuran</h4>';
  if (angsuranList.length === 0) {
    html += '<p>Belum ada pembayaran angsuran</p>';
  } else {
    html += '<div class="activity-list">';
    angsuranList.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); }).forEach(function(a) {
      html += '<div class="activity-item">';
      html += '<div>Angsuran ke-' + a.ke + ': Rp ' + a.nominal.toLocaleString('id-ID') + '</div>';
      html += '<div class="activity-date">' + new Date(a.created_at).toLocaleDateString('id-ID') + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }
  
  // Riwayat Iuran
  html += '<h4 style="margin-top: 16px; color: #374151;">üîÑ Riwayat Iuran</h4>';
  var iuranList = appData.iuran.filter(function(i) { return i.anggota === anggota.nama; });
  if (iuranList.length === 0) {
    html += '<p>Belum ada pembayaran iuran</p>';
  } else {
    html += '<div class="activity-list">';
    iuranList.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); }).forEach(function(i) {
      html += '<div class="activity-item">';
      html += '<div>Iuran ' + i.bulan + ': Rp ' + i.nominal.toLocaleString('id-ID') + '</div>';
      html += '<div class="activity-date">' + new Date(i.created_at).toLocaleDateString('id-ID') + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }
  
  html += '</div>';
  
  document.getElementById('detailContent').innerHTML = html;
}

function prosesPengembalianFromDetail() {
  if (!currentDetailAnggota) {
    alert('Pilih anggota terlebih dahulu');
    return;
  }
  
  if (currentDetailAnggota.status !== 'KELUAR') {
    if (!confirm('Anggota ini masih aktif. Apakah Anda yakin ingin memproses pengembalian iuran? Anggota akan otomatis di-set sebagai KELUAR.')) {
      return;
    }
    // Set status ke KELUAR
    currentDetailAnggota.status = 'KELUAR';
    currentDetailAnggota.tanggal_keluar = new Date().toISOString().split('T')[0];
  }
  
  navigate('pengembalian');
  setTimeout(function() {
    document.getElementById('refundAnggota').value = currentDetailAnggota.nama;
    hitungRefundOtomatis();
  }, 100);
}

function downloadDetailPDF() {
  if (!currentDetailAnggota) {
    alert('Pilih anggota terlebih dahulu');
    return;
  }
  
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF('p', 'mm', 'a4');
  
  var pageWidth = doc.internal.pageSize.getWidth();
  var margin = 15;
  var contentWidth = pageWidth - (margin * 2);
  var yPos = 20;
  
  var anggota = currentDetailAnggota;
  var totalIuran = getTotalIuranAnggota(anggota.nama);
  
  var sisaHutang = appData.pinjaman
    .filter(function(p) { return p.anggota === anggota.nama && p.sisa > 0; })
    .reduce(function(sum, p) { return sum + p.sisa; }, 0);
  
  var totalPinjaman = appData.pinjaman
    .filter(function(p) { return p.anggota === anggota.nama; })
    .reduce(function(sum, p) { return sum + p.nominal; }, 0);
  
  // Header
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text('LAPORAN DETAIL ANGGOTA', pageWidth / 2, yPos, { align: 'center' });
  yPos += 10;
  
  doc.setFontSize(12);
  doc.text(appData.settings.nama || 'Paguyuban Simpan Pinjam', pageWidth / 2, yPos, { align: 'center' });
  yPos += 6;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(appData.settings.alamat || 'Politeknik Negeri Madura', pageWidth / 2, yPos, { align: 'center' });
  yPos += 15;
  
  // Info Anggota
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('DATA ANGGOTA', margin, yPos);
  yPos += 8;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Nama: ' + anggota.nama, margin, yPos);
  yPos += 6;
  doc.text('Status: ' + (anggota.status || 'AKTIF'), margin, yPos);
  yPos += 6;
  doc.text('Tanggal Bergabung: ' + (anggota.masuk ? new Date(anggota.masuk).toLocaleDateString('id-ID') : '-'), margin, yPos);
  yPos += 6;
  if (anggota.status === 'KELUAR' && anggota.tanggal_keluar) {
    doc.text('Tanggal Keluar: ' + new Date(anggota.tanggal_keluar).toLocaleDateString('id-ID'), margin, yPos);
    yPos += 6;
  }
  
  // Gunakan fungsi hitungLamaBulan yang baru
  var lamaInfo = hitungLamaBulan(anggota.masuk, anggota.tanggal_keluar);
  doc.text('Lama Keanggotaan: ' + lamaInfo.text, margin, yPos);
  yPos += 10;
  
  // Ringkasan Keuangan
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('RINGKASAN KEUANGAN', margin, yPos);
  yPos += 8;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Total Iuran: Rp ' + totalIuran.toLocaleString('id-ID'), margin, yPos);
  yPos += 6;
  doc.text('Total Pinjaman: Rp ' + totalPinjaman.toLocaleString('id-ID'), margin, yPos);
  yPos += 6;
  doc.text('Sisa Hutang: Rp ' + sisaHutang.toLocaleString('id-ID'), margin, yPos);
  yPos += 10;
  
  // Cek pengembalian
  var refundData = appData.refund.find(function(r) { return r.anggota === anggota.nama; });
  if (refundData) {
    doc.text('Pengembalian Iuran: Rp ' + refundData.nominal.toLocaleString('id-ID'), margin, yPos);
    yPos += 10;
  }
  
  // Riwayat Pinjaman
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('RIWAYAT PINJAMAN', margin, yPos);
  yPos += 8;
  
  var pinjamanList = appData.pinjaman.filter(function(p) { return p.anggota === anggota.nama; });
  if (pinjamanList.length === 0) {
    doc.setFontSize(10);
    doc.text('Tidak ada riwayat pinjaman', margin, yPos);
    yPos += 6;
  } else {
    doc.setFontSize(9);
    pinjamanList.forEach(function(p) {
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      var status = p.sisa > 0 ? 'Berjalan' : 'Lunas';
      doc.text('- Pinjaman Rp ' + p.nominal.toLocaleString('id-ID') + ' (' + status + ')', margin, yPos);
      yPos += 5;
      doc.text('  Angsuran: Rp ' + p.angsuran.toLocaleString('id-ID') + '/bulan | Sisa: Rp ' + p.sisa.toLocaleString('id-ID'), margin + 5, yPos);
      yPos += 6;
    });
  }
  yPos += 4;
  
  // Riwayat Angsuran
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('RIWAYAT PEMBAYARAN ANGSURAN', margin, yPos);
  yPos += 8;
  
  var angsuranList = appData.angsuran.filter(function(a) { return a.anggota === anggota.nama; });
  if (angsuranList.length === 0) {
    doc.setFontSize(10);
    doc.text('Belum ada pembayaran angsuran', margin, yPos);
    yPos += 6;
  } else {
    doc.setFontSize(9);
    angsuranList.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); }).forEach(function(a) {
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      doc.text('- Angsuran ke-' + a.ke + ': Rp ' + a.nominal.toLocaleString('id-ID'), margin, yPos);
      yPos += 5;
      doc.text('  Tanggal: ' + new Date(a.created_at).toLocaleDateString('id-ID'), margin + 5, yPos);
      yPos += 6;
    });
  }
  yPos += 4;
  
  // Riwayat Iuran
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('RIWAYAT IURAN', margin, yPos);
  yPos += 8;
  
  var iuranList = appData.iuran.filter(function(i) { return i.anggota === anggota.nama; });
  if (iuranList.length === 0) {
    doc.setFontSize(10);
    doc.text('Belum ada pembayaran iuran', margin, yPos);
    yPos += 6;
  } else {
    doc.setFontSize(9);
    iuranList.sort(function(a, b) { return new Date(b.created_at) - new Date(a.created_at); }).forEach(function(i) {
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      doc.text('- Iuran ' + i.bulan + ': Rp ' + i.nominal.toLocaleString('id-ID'), margin, yPos);
      yPos += 5;
      doc.text('  Tanggal: ' + new Date(i.created_at).toLocaleDateString('id-ID'), margin + 5, yPos);
      yPos += 6;
    });
  }
  
  // Footer
  doc.setFontSize(8);
  doc.text('Dicetak: ' + new Date().toLocaleString('id-ID'), margin, 285);
  doc.text('Created & Developed by D.D Candra', pageWidth - margin, 285, { align: 'right' });
  
  doc.save('detail_' + anggota.nama.replace(/\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf');
}

function renderPengajuan() {
  var select = document.getElementById('pjAnggota');
  var options = '<option value="">Pilih Anggota</option>';
  // Hanya tampilkan anggota aktif
  appData.anggota.filter(function(a) { return a.status !== 'KELUAR'; }).forEach(function(a) {
    options += '<option value="' + a.nama + '">' + a.nama + '</option>';
  });
  select.innerHTML = options;
  
  var list = document.getElementById('pjList');
  var pending = appData.pengajuan.filter(function(p) { return p.status === 'MENUNGGU'; });
  
  if (!pending.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Tidak ada pengajuan pending</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Anggota</th><th>Nominal</th><th>Tenor</th><th>Aksi</th></tr></thead><tbody>';
  pending.forEach(function(p) {
    html += '<tr><td>' + p.anggota + '</td><td>Rp ' + p.nominal.toLocaleString('id-ID') + '</td><td>' + p.lama + ' bln</td><td>' +
      '<button class="btn-small btn-success" onclick="cairkan(\'' + p.id + '\')">Cairkan</button>' +
      '<button class="btn-small btn-warning" onclick="editPengajuan(\'' + p.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="hapusPengajuan(\'' + p.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

// ==========================================
// PENCAIRAN DENGAN FILTER DAN EDIT/HAPUS
// ==========================================
function renderPencairan() {
  // Populate filter nama
  var filterNama = document.getElementById('filterCairNama');
  var options = '<option value="">Semua Anggota</option>';
  appData.anggota.forEach(function(a) {
    options += '<option value="' + a.nama + '">' + a.nama + '</option>';
  });
  filterNama.innerHTML = options;
  
  applyFilterPencairan();
}

function applyFilterPencairan() {
  filterPencairan.nama = document.getElementById('filterCairNama').value;
  filterPencairan.bulan = document.getElementById('filterCairBulan').value;
  filterPencairan.tanggal = document.getElementById('filterCairTanggal').value;
  
  var filtered = appData.pinjaman.filter(function(p) {
    // Filter nama
    if (filterPencairan.nama && p.anggota !== filterPencairan.nama) return false;
    
    // Filter bulan
    if (filterPencairan.bulan && p.tanggal) {
      var pinjamBulan = p.tanggal.substring(0, 7); // Format YYYY-MM
      if (pinjamBulan !== filterPencairan.bulan) return false;
    }
    
    // Filter tanggal spesifik
    if (filterPencairan.tanggal && p.tanggal !== filterPencairan.tanggal) return false;
    
    return true;
  });
  
  var list = document.getElementById('cairList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Belum ada pencairan yang sesuai filter</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Anggota</th><th>Pinjaman</th><th>Angsuran</th><th>Sisa</th><th>Tanggal</th><th>Aksi</th></tr></thead><tbody>';
  filtered.forEach(function(p) {
    var tgl = p.tanggal ? new Date(p.tanggal).toLocaleDateString('id-ID') : '-';
    html += '<tr><td>' + p.anggota + '</td><td>Rp ' + p.nominal.toLocaleString('id-ID') + '</td><td>Rp ' + p.angsuran.toLocaleString('id-ID') + '/bln</td><td><strong>Rp ' + p.sisa.toLocaleString('id-ID') + '</strong></td><td>' + tgl + '</td><td>' +
      '<button class="btn-small btn-warning" onclick="editPencairan(\'' + p.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deletePencairan(\'' + p.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

function resetFilterPencairan() {
  document.getElementById('filterCairNama').value = '';
  document.getElementById('filterCairBulan').value = '';
  document.getElementById('filterCairTanggal').value = '';
  applyFilterPencairan();
}

function editPencairan(id) {
  var p = appData.pinjaman.find(function(x) { return x.id === id; });
  if (!p) return;
  
  // Buat form edit sederhana dengan prompt
  var newNominal = prompt('Edit Nominal Pinjaman:', p.nominal);
  if (newNominal === null) return;
  
  newNominal = parseInt(newNominal);
  if (isNaN(newNominal) || newNominal <= 0) {
    alert('Nominal tidak valid!');
    return;
  }
  
  // Edit tanggal pencairan
  var newTanggal = prompt('Edit Tanggal Pencairan (YYYY-MM-DD):', p.tanggal || '');
  if (newTanggal === null) return;
  
  // Validasi format tanggal
  if (newTanggal && !/^\d{4}-\d{2}-\d{2}$/.test(newTanggal)) {
    alert('Format tanggal tidak valid! Gunakan format YYYY-MM-DD');
    return;
  }
  
  // Hitung ulang angsuran
  var newAngsuran = Math.ceil(newNominal / p.lama);
  
  if (isDemoMode) {
    p.nominal = newNominal;
    p.angsuran = newAngsuran;
    p.tanggal = newTanggal || p.tanggal;
    // Adjust sisa if needed
    var totalAngsuran = appData.angsuran
      .filter(function(a) { return a.anggota === p.anggota; })
      .reduce(function(sum, a) { return sum + a.nominal; }, 0);
    p.sisa = Math.max(0, newNominal - totalAngsuran);
    saveDemoData();
    applyFilterPencairan();
    return;
  }
  
  showLoading(true);
  sbClient.from('pinjaman').update({ 
    nominal: newNominal, 
    angsuran: newAngsuran,
    tanggal: newTanggal || p.tanggal,
    sisa: Math.max(0, newNominal - (p.nominal - p.sisa))
  }).eq('id', id).then(function() {
    loadFromSupabase().then(function() {
      applyFilterPencairan();
      showLoading(false);
    });
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

function deletePencairan(id) {
  if (!confirm('Yakin hapus pencairan ini? Semua angsuran terkait juga akan dihapus!')) return;
  
  var p = appData.pinjaman.find(function(x) { return x.id === id; });
  if (!p) return;
  
  if (isDemoMode) {
    // Hapus pinjaman
    appData.pinjaman = appData.pinjaman.filter(function(x) { return x.id !== id; });
    // Hapus angsuran terkait
    appData.angsuran = appData.angsuran.filter(function(a) { return a.anggota !== p.anggota; });
    // Update kas (hapus transaksi pencairan)
    appData.kas = appData.kas.filter(function(k) { 
      return !(k.keterangan && k.keterangan.includes('Pencairan pinjaman ' + p.anggota)); 
    });
    saveDemoData();
    applyFilterPencairan();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  sbClient.from('pinjaman').delete().eq('id', id).then(function() {
    // Hapus angsuran terkait
    return sbClient.from('angsuran').delete().eq('anggota', p.anggota);
  }).then(function() {
    return loadFromSupabase();
  }).then(function() {
    applyFilterPencairan();
    updateDashboard();
    showLoading(false);
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

// ==========================================
// ANGSURAN DENGAN FILTER, EDIT, HAPUS, DAN TOTAL
// ==========================================
function renderAngsuran() {
  // Populate filter nama dan select angsuran
  var filterNama = document.getElementById('filterAngsuranNama');
  var angAnggota = document.getElementById('angAnggota');
  var options = '<option value="">Pilih Anggota</option>';
  var filterOptions = '<option value="">Semua Anggota</option>';
  
  appData.anggota.forEach(function(a) {
    options += '<option value="' + a.nama + '">' + a.nama + '</option>';
    filterOptions += '<option value="' + a.nama + '">' + a.nama + '</option>';
  });
  
  angAnggota.innerHTML = options;
  filterNama.innerHTML = filterOptions;
  
  applyFilterAngsuran();
}

function getMingguKe(date) {
  var d = new Date(date);
  var day = d.getDate();
  if (day <= 7) return 1;
  if (day <= 14) return 2;
  if (day <= 21) return 3;
  return 4;
}

function applyFilterAngsuran() {
  filterAngsuran.nama = document.getElementById('filterAngsuranNama').value;
  filterAngsuran.bulan = document.getElementById('filterAngsuranBulan').value;
  filterAngsuran.tanggal = document.getElementById('filterAngsuranTanggal').value;
  filterAngsuran.minggu = document.getElementById('filterAngsuranMinggu').value;
  
  var filtered = appData.angsuran.filter(function(a) {
    var date = new Date(a.created_at);
    
    // Filter nama
    if (filterAngsuran.nama && a.anggota !== filterAngsuran.nama) return false;
    
    // Filter bulan
    if (filterAngsuran.bulan) {
      var angsuranBulan = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
      if (angsuranBulan !== filterAngsuran.bulan) return false;
    }
    
    // Filter tanggal spesifik
    if (filterAngsuran.tanggal && a.created_at.split('T')[0] !== filterAngsuran.tanggal) return false;
    
    // Filter minggu
    if (filterAngsuran.minggu && getMingguKe(date) != filterAngsuran.minggu) return false;
    
    return true;
  });
  
  // Hitung total
  var totalNominal = filtered.reduce(function(sum, a) { return sum + (a.nominal || 0); }, 0);
  
  // Tampilkan total
  var totalContainer = document.getElementById('totalAngsuranContainer');
  if (filtered.length > 0) {
    totalContainer.classList.remove('hidden');
    document.getElementById('totalAngsuranValue').textContent = 'Rp ' + totalNominal.toLocaleString('id-ID');
  } else {
    totalContainer.classList.add('hidden');
  }
  
  var list = document.getElementById('angList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíµ</div><p>Belum ada pembayaran yang sesuai filter</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Anggota</th><th>Nominal</th><th>Ke-</th><th>Tanggal</th><th>Aksi</th></tr></thead><tbody>';
  var reversed = filtered.slice().reverse();
  reversed.forEach(function(a) {
    html += '<tr><td>' + a.anggota + '</td><td>Rp ' + a.nominal.toLocaleString('id-ID') + '</td><td>' + a.ke + '</td><td>' + new Date(a.created_at).toLocaleDateString('id-ID') + '</td><td>' +
      '<button class="btn-small btn-warning" onclick="editAngsuran(\'' + a.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deleteAngsuran(\'' + a.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

function resetFilterAngsuran() {
  document.getElementById('filterAngsuranNama').value = '';
  document.getElementById('filterAngsuranBulan').value = '';
  document.getElementById('filterAngsuranTanggal').value = '';
  document.getElementById('filterAngsuranMinggu').value = '';
  applyFilterAngsuran();
}

function editAngsuran(id) {
  var a = appData.angsuran.find(function(x) { return x.id === id; });
  if (!a) return;
  
  document.getElementById('angAnggota').value = a.anggota;
  document.getElementById('angNominal').value = a.nominal;
  document.getElementById('angKe').value = a.ke;
  document.getElementById('angId').value = id;
  
  calcSisa();
  
  // Scroll ke form
  document.getElementById('angAnggota').scrollIntoView({ behavior: 'smooth' });
}

function deleteAngsuran(id) {
  if (!confirm('Yakin hapus pembayaran angsuran ini?')) return;
  
  var a = appData.angsuran.find(function(x) { return x.id === id; });
  if (!a) return;
  
  if (isDemoMode) {
    // Kembalikan sisa pinjaman
    var p = appData.pinjaman.find(function(x) { return x.anggota === a.anggota; });
    if (p) {
      p.sisa += a.nominal;
    }
    
    // Hapus angsuran
    appData.angsuran = appData.angsuran.filter(function(x) { return x.id !== id; });
    
    // Hapus dari kas
    appData.kas = appData.kas.filter(function(k) { 
      return !(k.keterangan && k.keterangan.includes('Angsuran ' + a.anggota + ' ke-' + a.ke)); 
    });
    
    saveDemoData();
    applyFilterAngsuran();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  sbClient.from('angsuran').delete().eq('id', id).then(function() {
    // Kembalikan sisa pinjaman
    var p = appData.pinjaman.find(function(x) { return x.anggota === a.anggota; });
    if (p) {
      return sbClient.from('pinjaman').update({ 
        sisa: p.sisa + a.nominal 
      }).eq('id', p.id);
    }
  }).then(function() {
    return loadFromSupabase();
  }).then(function() {
    applyFilterAngsuran();
    updateDashboard();
    showLoading(false);
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

// ==========================================
// IURAN DENGAN FILTER DAN EDIT/HAPUS
// ==========================================
function renderIuran() {
  // Populate filter nama dan select iuran
  var filterNama = document.getElementById('filterIuranNama');
  var iurAnggota = document.getElementById('iurAnggota');
  var options = '<option value="">Pilih Anggota</option>';
  var filterOptions = '<option value="">Semua Anggota</option>';
  
  appData.anggota.forEach(function(a) {
    options += '<option value="' + a.nama + '">' + a.nama + '</option>';
    filterOptions += '<option value="' + a.nama + '">' + a.nama + '</option>';
  });
  
  iurAnggota.innerHTML = options;
  filterNama.innerHTML = filterOptions;
  
  applyFilterIuran();
}

function applyFilterIuran() {
  filterIuran.nama = document.getElementById('filterIuranNama').value;
  filterIuran.bulan = document.getElementById('filterIuranBulan').value;
  filterIuran.tanggal = document.getElementById('filterIuranTanggal').value;
  
  var filtered = appData.iuran.filter(function(i) {
    // Filter nama
    if (filterIuran.nama && i.anggota !== filterIuran.nama) return false;
    
    // Filter bulan
    if (filterIuran.bulan && i.bulan !== filterIuran.bulan) return false;
    
    // Filter tanggal spesifik
    if (filterIuran.tanggal && i.created_at) {
      var iuranTanggal = i.created_at.split('T')[0];
      if (iuranTanggal !== filterIuran.tanggal) return false;
    }
    
    return true;
  });
  
  var list = document.getElementById('iurList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><p>Belum ada iuran yang sesuai filter</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Anggota</th><th>Bulan</th><th>Nominal</th><th>Tanggal</th><th>Aksi</th></tr></thead><tbody>';
  var reversed = filtered.slice().reverse();
  reversed.forEach(function(i) {
    var tgl = i.created_at ? new Date(i.created_at).toLocaleDateString('id-ID') : '-';
    html += '<tr><td>' + i.anggota + '</td><td>' + i.bulan + '</td><td>Rp ' + i.nominal.toLocaleString('id-ID') + '</td><td>' + tgl + '</td><td>' +
      '<button class="btn-small btn-warning" onclick="editIuran(\'' + i.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deleteIuran(\'' + i.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

function resetFilterIuran() {
  document.getElementById('filterIuranNama').value = '';
  document.getElementById('filterIuranBulan').value = '';
  document.getElementById('filterIuranTanggal').value = '';
  applyFilterIuran();
}

function editIuran(id) {
  var i = appData.iuran.find(function(x) { return x.id === id; });
  if (!i) return;
  
  document.getElementById('iurAnggota').value = i.anggota;
  document.getElementById('iurNominal').value = i.nominal;
  document.getElementById('iurBulan').value = i.bulan;
  document.getElementById('iurId').value = id;
  
  // Scroll ke form
  document.getElementById('iurAnggota').scrollIntoView({ behavior: 'smooth' });
}

function deleteIuran(id) {
  if (!confirm('Yakin hapus iuran ini?')) return;
  
  var i = appData.iuran.find(function(x) { return x.id === id; });
  
  if (isDemoMode) {
    appData.iuran = appData.iuran.filter(function(x) { return x.id !== id; });
    // Hapus dari kas juga
    appData.kas = appData.kas.filter(function(k) { 
      return !(k.keterangan && k.keterangan.includes('Iuran ' + i.anggota + ' ' + i.bulan)); 
    });
    saveDemoData();
    applyFilterIuran();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  sbClient.from('iuran').delete().eq('id', id).then(function() {
    return loadFromSupabase();
  }).then(function() {
    applyFilterIuran();
    updateDashboard();
    showLoading(false);
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

// ==========================================
// PENGEMBALIAN IURAN (REFUND)
// ==========================================
function renderRefund() {
  // Populate filter nama dan select refund
  var filterNama = document.getElementById('filterRefundNama');
  var refundAnggota = document.getElementById('refundAnggota');
  
  var options = '<option value="">Pilih Anggota</option>';
  var filterOptions = '<option value="">Semua Anggota</option>';
  
  // Tampilkan semua anggota untuk filter, tapi hanya yang keluar untuk select
  appData.anggota.forEach(function(a) {
    filterOptions += '<option value="' + a.nama + '">' + a.nama + '</option>';
    if (a.status === 'KELUAR') {
      options += '<option value="' + a.nama + '">' + a.nama + ' (Keluar: ' + (a.tanggal_keluar ? new Date(a.tanggal_keluar).toLocaleDateString('id-ID') : '-') + ')</option>';
    }
  });
  
  refundAnggota.innerHTML = options;
  filterNama.innerHTML = filterOptions;
  
  // Set default tanggal hari ini
  if (!document.getElementById('refundTanggal').value) {
    document.getElementById('refundTanggal').value = new Date().toISOString().split('T')[0];
  }
  
  applyFilterRefund();
}

function hitungRefundOtomatis() {
  var nama = document.getElementById('refundAnggota').value;
  var infoContainer = document.getElementById('refundInfoContainer');
  
  if (!nama) {
    infoContainer.classList.add('hidden');
    document.getElementById('refundNominal').value = '';
    return;
  }
  
  var anggota = appData.anggota.find(function(a) { return a.nama === nama; });
  if (!anggota) {
    infoContainer.classList.add('hidden');
    return;
  }
  
  // Jika status belum keluar, set otomatis
  if (anggota.status !== 'KELUAR') {
    anggota.status = 'KELUAR';
    anggota.tanggal_keluar = new Date().toISOString().split('T')[0];
  }
  
  // Hitung total iuran yang sudah masuk
  var totalIuran = getTotalIuranAnggota(nama);
  
  // Hitung lama keanggotaan
  var lamaInfo = hitungLamaBulan(anggota.masuk, anggota.tanggal_keluar);
  
  // Tampilkan info
  infoContainer.classList.remove('hidden');
  document.getElementById('refundTanggalMasuk').textContent = anggota.masuk ? new Date(anggota.masuk).toLocaleDateString('id-ID') : '-';
  document.getElementById('refundTanggalKeluar').textContent = anggota.tanggal_keluar ? new Date(anggota.tanggal_keluar).toLocaleDateString('id-ID') : '-';
  document.getElementById('refundLamaBulan').textContent = lamaInfo.text + ' (' + lamaInfo.bulan + ' bulan)';
  document.getElementById('refundTotalIuranMasuk').textContent = 'Rp ' + totalIuran.toLocaleString('id-ID');
  document.getElementById('refundTotalDisplay').textContent = 'Rp ' + totalIuran.toLocaleString('id-ID');
  
  // Set nominal refund
  document.getElementById('refundNominal').value = totalIuran;
  document.getElementById('refundKeterangan').value = 'Pengembalian iuran ' + nama + ' (' + lamaInfo.text + ')';
}

function applyFilterRefund() {
  filterRefund.nama = document.getElementById('filterRefundNama').value;
  filterRefund.bulan = document.getElementById('filterRefundBulan').value;
  filterRefund.tanggal = document.getElementById('filterRefundTanggal').value;
  
  var filtered = appData.refund.filter(function(r) {
    // Filter nama
    if (filterRefund.nama && r.anggota !== filterRefund.nama) return false;
    
    // Filter bulan
    if (filterRefund.bulan && r.tanggal) {
      var refundBulan = r.tanggal.substring(0, 7);
      if (refundBulan !== filterRefund.bulan) return false;
    }
    
    // Filter tanggal spesifik
    if (filterRefund.tanggal && r.tanggal !== filterRefund.tanggal) return false;
    
    return true;
  });
  
  // Hitung total
  var totalNominal = filtered.reduce(function(sum, r) { return sum + (r.nominal || 0); }, 0);
  
  // Tampilkan total
  var totalContainer = document.getElementById('totalRefundContainer');
  if (filtered.length > 0) {
    totalContainer.classList.remove('hidden');
    document.getElementById('totalRefundValue').textContent = 'Rp ' + totalNominal.toLocaleString('id-ID');
  } else {
    totalContainer.classList.add('hidden');
  }
  
  var list = document.getElementById('refundList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∏</div><p>Belum ada pengembalian iuran</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Anggota</th><th>Nominal</th><th>Tanggal</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody>';
  var reversed = filtered.slice().reverse();
  reversed.forEach(function(r) {
    var tgl = r.tanggal ? new Date(r.tanggal).toLocaleDateString('id-ID') : '-';
    html += '<tr><td>' + r.anggota + '</td><td><strong>Rp ' + r.nominal.toLocaleString('id-ID') + '</strong></td><td>' + tgl + '</td><td>' + (r.keterangan || '-') + '</td><td>' +
      '<button class="btn-small btn-warning" onclick="editRefund(\'' + r.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deleteRefund(\'' + r.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

function resetFilterRefund() {
  document.getElementById('filterRefundNama').value = '';
  document.getElementById('filterRefundBulan').value = '';
  document.getElementById('filterRefundTanggal').value = '';
  applyFilterRefund();
}

function saveRefund() {
  var anggota = document.getElementById('refundAnggota').value;
  var nominal = parseInt(document.getElementById('refundNominal').value);
  var tanggal = document.getElementById('refundTanggal').value;
  var keterangan = document.getElementById('refundKeterangan').value.trim();
  var id = document.getElementById('refundId').value;
  
  if (!anggota) { alert('Pilih anggota yang akan diproses!'); return; }
  if (!nominal || nominal <= 0) { alert('Nominal pengembalian harus lebih dari 0!'); return; }
  if (!tanggal) { alert('Tanggal pengembalian wajib diisi!'); return; }
  
  // Cek apakah anggota sudah ada refund sebelumnya (hanya untuk tambah baru)
  if (!id) {
    var existingRefund = appData.refund.find(function(r) { return r.anggota === anggota; });
    if (existingRefund) {
      if (!confirm('Anggota ini sudah pernah diproses pengembalian iuran sebelumnya. Apakah Anda yakin ingin menambahkan pengembalian lagi?')) {
        return;
      }
    }
  }
  
  if (isDemoMode) {
    if (id) {
      // Edit mode
      var idx = appData.refund.findIndex(function(r) { return r.id === id; });
      if (idx >= 0) {
        var oldNominal = appData.refund[idx].nominal;
        appData.refund[idx].anggota = anggota;
        appData.refund[idx].nominal = nominal;
        appData.refund[idx].tanggal = tanggal;
        appData.refund[idx].keterangan = keterangan;
        
        // Update kas (kurangi selisih)
        var selisih = nominal - oldNominal;
        var k = appData.kas.find(function(x) { 
          return x.keterangan && x.keterangan.includes('Pengembalian iuran ' + anggota); 
        });
        if (k) {
          k.nominal = nominal;
          k.tanggal = tanggal;
          k.created_at = tanggal + 'T00:00:00.000Z';
        }
      }
    } else {
      // Add new
      appData.refund.push({
        id: 'demo_' + Date.now(),
        anggota: anggota,
        nominal: nominal,
        tanggal: tanggal,
        keterangan: keterangan,
        created_at: new Date().toISOString()
      });
      
      // Update status anggota menjadi KELUAR jika belum
      var a = appData.anggota.find(function(x) { return x.nama === anggota; });
      if (a && a.status !== 'KELUAR') {
        a.status = 'KELUAR';
        a.tanggal_keluar = tanggal;
      }
      
      // Tambah ke kas sebagai KREDIT (keluar)
      appData.kas.push({
        id: 'demo_' + Date.now(),
        jenis: 'KREDIT',
        nominal: nominal,
        keterangan: 'Pengembalian iuran ' + anggota,
        tanggal: tanggal,
        created_at: tanggal + 'T00:00:00.000Z'
      });
    }
    saveDemoData();
    resetRefundForm();
    applyFilterRefund();
    updateDashboard();
    alert('Pengembalian iuran berhasil diproses!');
    return;
  }
  
  showLoading(true);
  
  var savePromise;
  if (id) {
    savePromise = sbClient.from('refund').update({
      anggota: anggota,
      nominal: nominal,
      tanggal: tanggal,
      keterangan: keterangan
    }).eq('id', id);
  } else {
    savePromise = sbClient.from('refund').insert([{
      anggota: anggota,
      nominal: nominal,
      tanggal: tanggal,
      keterangan: keterangan
    }]);
  }
  
  savePromise.then(function() {
    // Update status anggota
    return sbClient.from('anggota').update({
      status: 'KELUAR',
      tanggal_keluar: tanggal
    }).eq('nama', anggota);
  }).then(function() {
    // Update kas
    if (id) {
      return sbClient.from('kas').update({
        nominal: nominal,
        tanggal: tanggal,
        created_at: tanggal + 'T00:00:00.000Z'
      }).eq('keterangan', 'Pengembalian iuran ' + anggota);
    } else {
      return sbClient.from('kas').insert([{
        jenis: 'KREDIT',
        nominal: nominal,
        keterangan: 'Pengembalian iuran ' + anggota,
        tanggal: tanggal
      }]);
    }
  }).then(function() {
    return loadFromSupabase();
  }).then(function() {
    resetRefundForm();
    applyFilterRefund();
    updateDashboard();
    showLoading(false);
    alert('Pengembalian iuran berhasil diproses!');
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

function editRefund(id) {
  var r = appData.refund.find(function(x) { return x.id === id; });
  if (!r) return;
  
  document.getElementById('refundAnggota').value = r.anggota;
  document.getElementById('refundNominal').value = r.nominal;
  document.getElementById('refundTanggal').value = r.tanggal;
  document.getElementById('refundKeterangan').value = r.keterangan || '';
  document.getElementById('refundId').value = id;
  
  // Tampilkan info
  hitungRefundOtomatis();
  
  // Scroll ke form
  document.getElementById('refundAnggota').scrollIntoView({ behavior: 'smooth' });
}

function deleteRefund(id) {
  if (!confirm('Yakin hapus data pengembalian iuran ini?')) return;
  
  var r = appData.refund.find(function(x) { return x.id === id; });
  if (!r) return;
  
  if (isDemoMode) {
    appData.refund = appData.refund.filter(function(x) { return x.id !== id; });
    // Hapus dari kas
    appData.kas = appData.kas.filter(function(k) { 
      return !(k.keterangan && k.keterangan.includes('Pengembalian iuran ' + r.anggota)); 
    });
    saveDemoData();
    applyFilterRefund();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  sbClient.from('refund').delete().eq('id', id).then(function() {
    // Hapus dari kas
    return sbClient.from('kas').delete().eq('keterangan', 'Pengembalian iuran ' + r.anggota);
  }).then(function() {
    return loadFromSupabase();
  }).then(function() {
    applyFilterRefund();
    updateDashboard();
    showLoading(false);
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

// ==========================================
// SALDO MANAJEMEN DENGAN RINGKASAN
// ==========================================
function renderSaldo() {
  // Hitung summary
  var totalDebet = 0;
  var totalKredit = 0;
  
  appData.kas.forEach(function(k) {
    if (k.jenis === 'DEBET') {
      totalDebet += (k.nominal || 0);
    } else {
      totalKredit += (k.nominal || 0);
    }
  });
  
  var totalSaldo = totalDebet - totalKredit;
  var totalTransaksi = appData.kas.length;
  
  // Update summary box
  document.getElementById('summaryDebet').textContent = 'Rp ' + totalDebet.toLocaleString('id-ID');
  document.getElementById('summaryKredit').textContent = 'Rp ' + totalKredit.toLocaleString('id-ID');
  document.getElementById('summaryTransaksi').textContent = totalTransaksi;
  document.getElementById('saldoTotal').textContent = 'Rp ' + totalSaldo.toLocaleString('id-ID');
  
  // Set default tanggal hari ini
  if (!document.getElementById('saldoTanggal').value) {
    document.getElementById('saldoTanggal').value = new Date().toISOString().split('T')[0];
  }
  
  var list = document.getElementById('saldoList');
  if (!appData.kas.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><p>Belum ada transaksi saldo</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>';
  var reversed = appData.kas.slice().reverse();
  reversed.forEach(function(k) {
    var jenisBadge = k.jenis === 'DEBET' ? 
      '<span class="badge badge-ok">DEBET</span>' : 
      '<span class="badge badge-wait">KREDIT</span>';
    
    html += '<tr><td>' + new Date(k.created_at || k.tanggal || new Date()).toLocaleDateString('id-ID') + '</td>' +
      '<td>' + (k.keterangan || '-') + '</td>' +
      '<td>' + jenisBadge + '</td>' +
      '<td>Rp ' + (k.nominal || 0).toLocaleString('id-ID') + '</td>' +
      '<td>' +
      '<button class="btn-small btn-warning" onclick="editSaldo(\'' + k.id + '\')">Edit</button>' +
      '<button class="btn-small btn-danger" onclick="deleteSaldo(\'' + k.id + '\')">Hapus</button>' +
      '</td></tr>';
  });
  html += '</tbody></table></div>';
  list.innerHTML = html;
}

function resetSaldoForm() {
  document.getElementById('saldoJenis').value = 'DEBET';
  document.getElementById('saldoNominal').value = '';
  document.getElementById('saldoKeterangan').value = '';
  document.getElementById('saldoTanggal').value = new Date().toISOString().split('T')[0];
  document.getElementById('saldoId').value = '';
}

async function saveSaldo() {
  var jenis = document.getElementById('saldoJenis').value;
  var nominal = parseInt(document.getElementById('saldoNominal').value);
  var keterangan = document.getElementById('saldoKeterangan').value.trim();
  var tanggal = document.getElementById('saldoTanggal').value;
  var id = document.getElementById('saldoId').value;
  
  if (!nominal || nominal <= 0) {
    alert('Nominal harus lebih dari 0!');
    return;
  }
  
  if (isDemoMode) {
    if (id) {
      // Edit mode
      var idx = appData.kas.findIndex(function(k) { return k.id === id; });
      if (idx >= 0) {
        appData.kas[idx].jenis = jenis;
        appData.kas[idx].nominal = nominal;
        appData.kas[idx].keterangan = keterangan;
        appData.kas[idx].tanggal = tanggal;
        appData.kas[idx].created_at = tanggal + 'T00:00:00.000Z';
      }
    } else {
      // Add new
      appData.kas.push({
        id: 'demo_' + Date.now(),
        jenis: jenis,
        nominal: nominal,
        keterangan: keterangan,
        tanggal: tanggal,
        created_at: tanggal ? tanggal + 'T00:00:00.000Z' : new Date().toISOString()
      });
    }
    saveDemoData();
    resetSaldoForm();
    renderSaldo();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  try {
    if (id) {
      await sbClient.from('kas').update({
        jenis: jenis,
        nominal: nominal,
        keterangan: keterangan,
        tanggal: tanggal,
        created_at: tanggal ? tanggal + 'T00:00:00.000Z' : new Date().toISOString()
      }).eq('id', id);
    } else {
      await sbClient.from('kas').insert([{
        jenis: jenis,
        nominal: nominal,
        keterangan: keterangan,
        tanggal: tanggal,
        created_at: tanggal ? tanggal + 'T00:00:00.000Z' : new Date().toISOString()
      }]);
    }
    await loadFromSupabase();
    resetSaldoForm();
    renderSaldo();
    updateDashboard();
  } catch (e) {
    alert('Error: ' + e.message);
  }
  showLoading(false);
}

function editSaldo(id) {
  var k = appData.kas.find(function(x) { return x.id === id; });
  if (!k) return;
  
  document.getElementById('saldoJenis').value = k.jenis;
  document.getElementById('saldoNominal').value = k.nominal;
  document.getElementById('saldoKeterangan').value = k.keterangan || '';
  document.getElementById('saldoTanggal').value = k.tanggal || (k.created_at ? k.created_at.split('T')[0] : '');
  document.getElementById('saldoId').value = id;
}

async function deleteSaldo(id) {
  if (!confirm('Yakin hapus transaksi saldo ini?')) return;
  
  if (isDemoMode) {
    appData.kas = appData.kas.filter(function(k) { return k.id !== id; });
    saveDemoData();
    renderSaldo();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  try {
    await sbClient.from('kas').delete().eq('id', id);
    await loadFromSupabase();
    renderSaldo();
    updateDashboard();
  } catch (e) {
    alert('Error: ' + e.message);
  }
  showLoading(false);
}

function renderSettings() {
  document.getElementById('setNama').value = appData.settings.nama || '';
  document.getElementById('setTagline').value = appData.settings.tagline || '';
  document.getElementById('setAlamat').value = appData.settings.alamat || '';
  
  var logoPreview = document.getElementById('logoPreview');
  if (appData.settings.logo) {
    logoPreview.src = appData.settings.logo;
    logoPreview.style.display = 'block';
  } else {
    logoPreview.style.display = 'none';
  }
}

// ==========================================
// LAPORAN DENGAN FILTER LENGKAP
// ==========================================
function renderLaporan() {
  // Populate filter nama
  var filterNama = document.getElementById('filterLapNama');
  var options = '<option value="">Semua Anggota</option>';
  appData.anggota.forEach(function(a) {
    options += '<option value="' + a.nama + '">' + a.nama + '</option>';
  });
  filterNama.innerHTML = options;
  
  previewLaporan();
}

function previewLaporan() {
  filterLaporan.nama = document.getElementById('filterLapNama').value;
  filterLaporan.tanggal = document.getElementById('filterLapTanggal').value;
  filterLaporan.minggu = document.getElementById('filterLapMinggu').value;
  filterLaporan.bulan = document.getElementById('filterLapBulan').value;
  filterLaporan.tahun = document.getElementById('filterLapTahun').value;
  
  // Kumpulkan semua transaksi dari berbagai sumber
  var allTransaksi = [];
  
  // 1. Angsuran
  appData.angsuran.forEach(function(a) {
    var date = new Date(a.created_at);
    var include = true;
    
    if (filterLaporan.nama && a.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && a.created_at.split('T')[0] !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan) {
      var transBulan = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
      if (transBulan !== filterLaporan.bulan) include = false;
    }
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: a.created_at,
        jenis: 'ANGSURAN',
        keterangan: 'Angsuran ke-' + a.ke + ' - ' + a.anggota,
        nominal: a.nominal,
        tipe: 'DEBET',
        anggota: a.anggota
      });
    }
  });
  
  // 2. Pencairan Pinjaman
  appData.pinjaman.forEach(function(p) {
    if (!p.tanggal) return;
    var date = new Date(p.tanggal);
    var include = true;
    
    if (filterLaporan.nama && p.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && p.tanggal !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan && p.tanggal.substring(0, 7) !== filterLaporan.bulan) include = false;
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: p.tanggal + 'T00:00:00.000Z',
        jenis: 'PENCAIRAN',
        keterangan: 'Pencairan Pinjaman - ' + p.anggota,
        nominal: p.nominal,
        tipe: 'KREDIT',
        anggota: p.anggota
      });
    }
  });
  
  // 3. Iuran
  appData.iuran.forEach(function(i) {
    var date = new Date(i.created_at);
    var include = true;
    
    if (filterLaporan.nama && i.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && i.created_at.split('T')[0] !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan && i.bulan !== filterLaporan.bulan) include = false;
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: i.created_at,
        jenis: 'IURAN',
        keterangan: 'Iuran ' + i.bulan + ' - ' + i.anggota,
        nominal: i.nominal,
        tipe: 'DEBET',
        anggota: i.anggota
      });
    }
  });
  
  // 4. Pengembalian Iuran
  appData.refund.forEach(function(r) {
    var date = new Date(r.tanggal);
    var include = true;
    
    if (filterLaporan.nama && r.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && r.tanggal !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan) {
      var refundBulan = r.tanggal.substring(0, 7);
      if (refundBulan !== filterLaporan.bulan) include = false;
    }
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: r.tanggal + 'T00:00:00.000Z',
        jenis: 'PENGEMBALIAN',
        keterangan: 'Pengembalian Iuran - ' + r.anggota,
        nominal: r.nominal,
        tipe: 'KREDIT',
        anggota: r.anggota
      });
    }
  });
  
  // Sort by tanggal
  allTransaksi.sort(function(a, b) {
    return new Date(a.tanggal) - new Date(b.tanggal);
  });
  
  // Render preview
  var container = document.getElementById('laporanPreview');
  
  if (allTransaksi.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>Tidak ada transaksi untuk filter yang dipilih</p></div>';
    return;
  }
  
  var html = '<div class="table-wrap"><table><thead><tr><th>Tanggal</th><th>Jenis</th><th>Keterangan</th><th>Debet</th><th>Kredit</th></tr></thead><tbody>';
  
  var totalDebet = 0;
  var totalKredit = 0;
  
  allTransaksi.forEach(function(t) {
    var tgl = new Date(t.tanggal).toLocaleDateString('id-ID');
    var debet = t.tipe === 'DEBET' ? 'Rp ' + t.nominal.toLocaleString('id-ID') : '';
    var kredit = t.tipe === 'KREDIT' ? 'Rp ' + t.nominal.toLocaleString('id-ID') : '';
    
    if (t.tipe === 'DEBET') totalDebet += t.nominal;
    else totalKredit += t.nominal;
    
    var jenisBadge = '';
    if (t.jenis === 'ANGSURAN') jenisBadge = '<span class="badge badge-ok">Angsuran</span>';
    else if (t.jenis === 'PENCAIRAN') jenisBadge = '<span class="badge badge-wait">Pencairan</span>';
    else if (t.jenis === 'IURAN') jenisBadge = '<span class="badge badge-ok">Iuran</span>';
    else if (t.jenis === 'PENGEMBALIAN') jenisBadge = '<span class="badge badge-danger">Pengembalian</span>';
    
    html += '<tr><td>' + tgl + '</td><td>' + jenisBadge + '</td><td>' + t.keterangan + '</td><td>' + debet + '</td><td>' + kredit + '</td></tr>';
  });
  
  html += '</tbody><tfoot style="background: #f3f4f6; font-weight: bold;"><tr><td colspan="3">TOTAL</td><td>Rp ' + totalDebet.toLocaleString('id-ID') + '</td><td>Rp ' + totalKredit.toLocaleString('id-ID') + '</td></tr></tfoot></table></div>';
  
  // Ringkasan
  html += '<div style="margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 8px;">';
  html += '<h4 style="margin-top: 0; color: #0369a1;">Ringkasan</h4>';
  html += '<p><strong>Total Transaksi:</strong> ' + allTransaksi.length + '</p>';
  html += '<p><strong>Total Debet (Masuk):</strong> Rp ' + totalDebet.toLocaleString('id-ID') + '</p>';
  html += '<p><strong>Total Kredit (Keluar):</strong> Rp ' + totalKredit.toLocaleString('id-ID') + '</p>';
  html += '<p><strong>Saldo:</strong> Rp ' + (totalDebet - totalKredit).toLocaleString('id-ID') + '</p>';
  html += '</div>';
  
  container.innerHTML = html;
}

function resetFilterLaporan() {
  document.getElementById('filterLapNama').value = '';
  document.getElementById('filterLapTanggal').value = '';
  document.getElementById('filterLapMinggu').value = '';
  document.getElementById('filterLapBulan').value = '';
  document.getElementById('filterLapTahun').value = '';
  previewLaporan();
}

// ==========================================
// LOGO PREVIEW
// ==========================================
function previewLogo(input) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('logoPreview').src = e.target.result;
      document.getElementById('logoPreview').style.display = 'block';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

// ==========================================
// ACTIONS
// ==========================================
async function saveAnggota() {
  var nama = document.getElementById('aggNama').value.trim();
  var masuk = document.getElementById('aggTanggal').value;
  var status = document.getElementById('aggStatus').value;
  var tanggal_keluar = document.getElementById('aggTanggalKeluar').value;
  var id = document.getElementById('aggId').value;
  
  if (!nama) { alert('Nama wajib diisi!'); return; }
  
  if (isDemoMode) {
    if (id) {
      var idx = appData.anggota.findIndex(function(a) { return a.id === id; });
      if (idx >= 0) { 
        appData.anggota[idx].nama = nama; 
        appData.anggota[idx].masuk = masuk; 
        appData.anggota[idx].status = status;
        appData.anggota[idx].tanggal_keluar = status === 'KELUAR' ? tanggal_keluar : null;
      }
    } else {
      appData.anggota.push({ 
        id: 'demo_' + Date.now(), 
        nama: nama, 
        masuk: masuk, 
        status: status,
        tanggal_keluar: status === 'KELUAR' ? tanggal_keluar : null,
        created_at: new Date().toISOString() 
      });
    }
    saveDemoData();
    resetAnggotaForm();
    renderAnggota();
    return;
  }
  
  showLoading(true);
  try {
    if (id) {
      await sbClient.from('anggota').update({ 
        nama: nama, 
        masuk: masuk,
        status: status,
        tanggal_keluar: status === 'KELUAR' ? tanggal_keluar : null
      }).eq('id', id);
    } else {
      await sbClient.from('anggota').insert([{ 
        nama: nama, 
        masuk: masuk,
        status: status,
        tanggal_keluar: status === 'KELUAR' ? tanggal_keluar : null
      }]);
    }
    await loadFromSupabase();
    resetAnggotaForm();
    renderAnggota();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

function resetAnggotaForm() {
  document.getElementById('aggNama').value = '';
  document.getElementById('aggTanggal').value = '';
  document.getElementById('aggStatus').value = 'AKTIF';
  document.getElementById('aggTanggalKeluar').value = '';
  document.getElementById('aggKeluarContainer').style.display = 'none';
  document.getElementById('aggId').value = '';
}

function editAnggota(id) {
  var a = appData.anggota.find(function(x) { return x.id === id; });
  if (!a) return;
  document.getElementById('aggNama').value = a.nama;
  document.getElementById('aggTanggal').value = a.masuk || '';
  document.getElementById('aggStatus').value = a.status || 'AKTIF';
  if (a.status === 'KELUAR') {
    document.getElementById('aggKeluarContainer').style.display = 'block';
    document.getElementById('aggTanggalKeluar').value = a.tanggal_keluar || '';
  } else {
    document.getElementById('aggKeluarContainer').style.display = 'none';
  }
  document.getElementById('aggId').value = id;
}

function setAnggotaKeluar(id) {
  var a = appData.anggota.find(function(x) { return x.id === id; });
  if (!a) return;
  
  if (!confirm('Set anggota "' + a.nama + '" sebagai KELUAR?')) return;
  
  var tanggalKeluar = prompt('Masukkan tanggal keluar (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
  if (!tanggalKeluar) return;
  
  if (!/^\d{4}-\d{2}-\d{2}$/.test(tanggalKeluar)) {
    alert('Format tanggal tidak valid! Gunakan format YYYY-MM-DD');
    return;
  }
  
  if (isDemoMode) {
    a.status = 'KELUAR';
    a.tanggal_keluar = tanggalKeluar;
    saveDemoData();
    renderAnggota();
    alert('Status anggota diubah menjadi KELUAR. Silakan proses pengembalian iuran di menu Pengembalian Iuran.');
    return;
  }
  
  showLoading(true);
  sbClient.from('anggota').update({
    status: 'KELUAR',
    tanggal_keluar: tanggalKeluar
  }).eq('id', id).then(function() {
    return loadFromSupabase();
  }).then(function() {
    renderAnggota();
    showLoading(false);
    alert('Status anggota diubah menjadi KELUAR. Silakan proses pengembalian iuran di menu Pengembalian Iuran.');
  }).catch(function(e) {
    alert('Error: ' + e.message);
    showLoading(false);
  });
}

async function deleteAnggota(id) {
  if (!confirm('Yakin hapus anggota ini? Semua data terkait (pinjaman, angsuran, iuran) juga akan dihapus!')) return;
  
  if (isDemoMode) {
    var a = appData.anggota.find(function(x) { return x.id === id; });
    if (a) {
      // Hapus semua data terkait
      appData.pinjaman = appData.pinjaman.filter(function(p) { return p.anggota !== a.nama; });
      appData.angsuran = appData.angsuran.filter(function(x) { return x.anggota !== a.nama; });
      appData.iuran = appData.iuran.filter(function(x) { return x.anggota !== a.nama; });
      appData.pengajuan = appData.pengajuan.filter(function(x) { return x.anggota !== a.nama; });
      appData.refund = appData.refund.filter(function(x) { return x.anggota !== a.nama; });
      appData.kas = appData.kas.filter(function(k) { 
        return !(k.keterangan && (k.keterangan.includes(a.nama))); 
      });
    }
    appData.anggota = appData.anggota.filter(function(a) { return a.id !== id; });
    saveDemoData();
    renderAnggota();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  try {
    var a = appData.anggota.find(function(x) { return x.id === id; });
    if (a) {
      // Hapus semua data terkait
      await sbClient.from('pinjaman').delete().eq('anggota', a.nama);
      await sbClient.from('angsuran').delete().eq('anggota', a.nama);
      await sbClient.from('iuran').delete().eq('anggota', a.nama);
      await sbClient.from('pengajuan').delete().eq('anggota', a.nama);
      await sbClient.from('refund').delete().eq('anggota', a.nama);
    }
    await sbClient.from('anggota').delete().eq('id', id);
    await loadFromSupabase();
    renderAnggota();
    updateDashboard();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

async function savePengajuan() {
  var anggota = document.getElementById('pjAnggota').value;
  var nominal = parseInt(document.getElementById('pjNominal').value);
  var lama = parseInt(document.getElementById('pjTenor').value);
  
  if (!anggota || !nominal || !lama) { alert('Semua field wajib diisi!'); return; }
  
  if (isDemoMode) {
    appData.pengajuan.push({ id: 'demo_' + Date.now(), anggota: anggota, nominal: nominal, lama: lama, status: 'MENUNGGU', created_at: new Date().toISOString() });
    saveDemoData();
    resetPengajuanForm();
    renderPengajuan();
    return;
  }
  
  showLoading(true);
  try {
    await sbClient.from('pengajuan').insert([{ anggota: anggota, nominal: nominal, lama: lama, status: 'MENUNGGU' }]);
    await loadFromSupabase();
    resetPengajuanForm();
    renderPengajuan();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

function resetPengajuanForm() {
  document.getElementById('pjAnggota').value = '';
  document.getElementById('pjNominal').value = '';
  document.getElementById('pjTenor').value = '';
  document.getElementById('pjId').value = '';
}

function editPengajuan(id) {
  var p = appData.pengajuan.find(function(x) { return x.id === id; });
  if (!p) return;
  
  document.getElementById('pjAnggota').value = p.anggota;
  document.getElementById('pjNominal').value = p.nominal;
  document.getElementById('pjTenor').value = p.lama;
  document.getElementById('pjId').value = id;
  
  // Scroll ke form
  document.getElementById('pjAnggota').scrollIntoView({ behavior: 'smooth' });
}

async function cairkan(id) {
  var p = appData.pengajuan.find(function(x) { return x.id === id; });
  if (!p) return;
  
  var angsuran = Math.ceil(p.nominal / p.lama);
  var today = new Date().toISOString().split('T')[0];
  
  if (isDemoMode) {
    p.status = 'DICAIRKAN';
    appData.pinjaman.push({ id: 'demo_' + Date.now(), anggota: p.anggota, nominal: p.nominal, lama: p.lama, angsuran: angsuran, sisa: p.nominal, tanggal: today, created_at: new Date().toISOString() });
    appData.kas.push({ id: 'demo_' + Date.now(), jenis: 'KREDIT', nominal: p.nominal, keterangan: 'Pencairan pinjaman ' + p.anggota, tanggal: today, created_at: new Date().toISOString() });
    saveDemoData();
    renderPengajuan();
    return;
  }
  
  showLoading(true);
  try {
    await sbClient.from('pengajuan').update({ status: 'DICAIRKAN' }).eq('id', id);
    await sbClient.from('pinjaman').insert([{ anggota: p.anggota, nominal: p.nominal, lama: p.lama, angsuran: angsuran, sisa: p.nominal, tanggal: today }]);
    await sbClient.from('kas').insert([{ jenis: 'KREDIT', nominal: p.nominal, keterangan: 'Pencairan pinjaman ' + p.anggota, tanggal: today }]);
    await loadFromSupabase();
    renderPengajuan();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

async function hapusPengajuan(id) {
  if (!confirm('Hapus pengajuan ini?')) return;
  
  if (isDemoMode) {
    appData.pengajuan = appData.pengajuan.filter(function(p) { return p.id !== id; });
    saveDemoData();
    renderPengajuan();
    return;
  }
  
  showLoading(true);
  try {
    await sbClient.from('pengajuan').delete().eq('id', id);
    await loadFromSupabase();
    renderPengajuan();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

function calcSisa() {
  var nama = document.getElementById('angAnggota').value;
  var bayar = parseInt(document.getElementById('angNominal').value) || 0;
  var p = appData.pinjaman.find(function(x) { return x.anggota === nama && x.sisa > 0; });
  
  if (p) {
    var sisa = Math.max(0, p.sisa - bayar);
    document.getElementById('angSisa').value = 'Rp ' + sisa.toLocaleString('id-ID');
  } else {
    document.getElementById('angSisa').value = '';
  }
}

function resetAngsuranForm() {
  document.getElementById('angAnggota').value = '';
  document.getElementById('angNominal').value = '';
  document.getElementById('angKe').value = '';
  document.getElementById('angSisa').value = '';
  document.getElementById('angId').value = '';
}

async function saveAngsuran() {
  var anggota = document.getElementById('angAnggota').value;
  var nominal = parseInt(document.getElementById('angNominal').value);
  var ke = parseInt(document.getElementById('angKe').value);
  var id = document.getElementById('angId').value;
  
  if (!anggota || !nominal || !ke) { alert('Semua field wajib diisi!'); return; }
  
  var p = appData.pinjaman.find(function(x) { return x.anggota === anggota && x.sisa > 0; });
  if (!p && !id) { alert('Tidak ada pinjaman aktif!'); return; }
  if (!id && nominal > p.sisa) { alert('Nominal melebihi sisa!'); return; }
  
  if (isDemoMode) {
    if (id) {
      // Edit mode - hitung selisih
      var oldAngsuran = appData.angsuran.find(function(x) { return x.id === id; });
      var selisih = nominal - (oldAngsuran ? oldAngsuran.nominal : 0);
      
      var idx = appData.angsuran.findIndex(function(x) { return x.id === id; });
      if (idx >= 0) {
        appData.angsuran[idx].anggota = anggota;
        appData.angsuran[idx].nominal = nominal;
        appData.angsuran[idx].ke = ke;
        
        // Update pinjaman
        var pinj = appData.pinjaman.find(function(x) { return x.anggota === anggota; });
        if (pinj) {
          pinj.sisa = Math.max(0, pinj.sisa - selisih);
        }
        
        // Update kas
        var k = appData.kas.find(function(x) { 
          return x.keterangan && x.keterangan.includes('Angsuran ' + anggota + ' ke-' + ke); 
        });
        if (k) {
          k.nominal = nominal;
        }
      }
    } else {
      // Add new
      appData.angsuran.push({ id: 'demo_' + Date.now(), anggota: anggota, nominal: nominal, ke: ke, created_at: new Date().toISOString() });
      p.sisa -= nominal;
      appData.kas.push({ id: 'demo_' + Date.now(), jenis: 'DEBET', nominal: nominal, keterangan: 'Angsuran ' + anggota + ' ke-' + ke, created_at: new Date().toISOString() });
    }
    saveDemoData();
    resetAngsuranForm();
    applyFilterAngsuran();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  try {
    if (id) {
      // Edit mode
      var oldData = appData.angsuran.find(function(x) { return x.id === id; });
      var selisih = nominal - (oldData ? oldData.nominal : 0);
      
      await sbClient.from('angsuran').update({ anggota: anggota, nominal: nominal, ke: ke }).eq('id', id);
      
      // Update pinjaman
      var pinj = appData.pinjaman.find(function(x) { return x.anggota === anggota; });
      if (pinj) {
        await sbClient.from('pinjaman').update({ sisa: Math.max(0, pinj.sisa - selisih) }).eq('id', pinj.id);
      }
      
      // Update kas
      await sbClient.from('kas').update({ nominal: nominal }).eq('keterangan', 'Angsuran ' + anggota + ' ke-' + ke);
    } else {
      await sbClient.from('angsuran').insert([{ anggota: anggota, nominal: nominal, ke: ke }]);
      await sbClient.from('pinjaman').update({ sisa: p.sisa - nominal }).eq('id', p.id);
      await sbClient.from('kas').insert([{ jenis: 'DEBET', nominal: nominal, keterangan: 'Angsuran ' + anggota + ' ke-' + ke }]);
    }
    await loadFromSupabase();
    resetAngsuranForm();
    applyFilterAngsuran();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

function resetIuranForm() {
  document.getElementById('iurAnggota').value = '';
  document.getElementById('iurNominal').value = '';
  document.getElementById('iurBulan').value = '';
  document.getElementById('iurId').value = '';
}

async function saveIuran() {
  var anggota = document.getElementById('iurAnggota').value;
  var nominal = parseInt(document.getElementById('iurNominal').value);
  var bulan = document.getElementById('iurBulan').value;
  var id = document.getElementById('iurId').value;
  
  if (!anggota || !nominal || !bulan) { alert('Semua field wajib diisi!'); return; }
  
  if (isDemoMode) {
    if (id) {
      // Edit mode
      var idx = appData.iuran.findIndex(function(i) { return i.id === id; });
      if (idx >= 0) {
        appData.iuran[idx].anggota = anggota;
        appData.iuran[idx].nominal = nominal;
        appData.iuran[idx].bulan = bulan;
        
        // Update kas
        var k = appData.kas.find(function(x) { 
          return x.keterangan && x.keterangan.includes('Iuran ' + anggota + ' ' + bulan); 
        });
        if (k) {
          k.nominal = nominal;
        }
      }
    } else {
      // Add new
      appData.iuran.push({ id: 'demo_' + Date.now(), anggota: anggota, nominal: nominal, bulan: bulan, created_at: new Date().toISOString() });
      appData.kas.push({ id: 'demo_' + Date.now(), jenis: 'DEBET', nominal: nominal, keterangan: 'Iuran ' + anggota + ' ' + bulan, created_at: new Date().toISOString() });
    }
    saveDemoData();
    resetIuranForm();
    applyFilterIuran();
    updateDashboard();
    return;
  }
  
  showLoading(true);
  try {
    if (id) {
      await sbClient.from('iuran').update({ anggota: anggota, nominal: nominal, bulan: bulan }).eq('id', id);
      // Update kas
      await sbClient.from('kas').update({ nominal: nominal }).eq('keterangan', 'Iuran ' + anggota + ' ' + bulan);
    } else {
      await sbClient.from('iuran').insert([{ anggota: anggota, nominal: nominal, bulan: bulan }]);
      await sbClient.from('kas').insert([{ jenis: 'DEBET', nominal: nominal, keterangan: 'Iuran ' + anggota + ' ' + bulan }]);
    }
    await loadFromSupabase();
    resetIuranForm();
    applyFilterIuran();
  } catch (e) { alert('Error: ' + e.message); }
  showLoading(false);
}

function resetRefundForm() {
  document.getElementById('refundAnggota').value = '';
  document.getElementById('refundNominal').value = '';
  document.getElementById('refundTanggal').value = new Date().toISOString().split('T')[0];
  document.getElementById('refundKeterangan').value = '';
  document.getElementById('refundId').value = '';
  document.getElementById('refundInfoContainer').classList.add('hidden');
}

async function saveSettings() {
  var nama = document.getElementById('setNama').value || 'Paguyuban Simpan Pinjam';
  var tagline = document.getElementById('setTagline').value || '';
  var alamat = document.getElementById('setAlamat').value || 'Politeknik Negeri Madura';
  
  var logoPreview = document.getElementById('logoPreview');
  var logo = null;
  if (logoPreview.src && logoPreview.style.display !== 'none' && logoPreview.src.includes('data:image')) {
    logo = logoPreview.src;
  }
  
  appData.settings = {
    nama: nama,
    tagline: tagline,
    alamat: alamat,
    logo: logo
  };
  
  // Simpan ke localStorage terlebih dahulu
  localStorage.setItem('paguyuban_settings', JSON.stringify(appData.settings));
  
  // Update tampilan header langsung
  updateHeaderSettings();
  
  if (isDemoMode) {
    saveDemoData();
    alert('Pengaturan disimpan!');
    return;
  }
  
  showLoading(true);
  try {
    // Cek apakah sudah ada settings
    var check = await sbClient.from('setting').select('*').eq('key', 'app').single();
    
    if (check.data) {
      // Update existing
      await sbClient.from('setting').update({ value: appData.settings }).eq('key', 'app');
    } else {
      // Insert new
      await sbClient.from('setting').insert([{ key: 'app', value: appData.settings }]);
    }
    
    await loadFromSupabase();
    alert('Pengaturan disimpan!');
  } catch (e) {
    console.error('Save settings error:', e);
    // Tetap tampilkan sukses karena sudah disimpan di localStorage
    alert('Pengaturan disimpan (mode lokal)!');
  }
  showLoading(false);
}

function resetSettingsForm() {
  document.getElementById('setNama').value = 'Paguyuban Simpan Pinjam';
  document.getElementById('setTagline').value = 'Tanpa Bunga ‚Ä¢ Kekeluargaan';
  document.getElementById('setAlamat').value = 'Politeknik Negeri Madura';
  document.getElementById('setLogo').value = '';
  document.getElementById('logoPreview').style.display = 'none';
}

function exportData() {
  var blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'backup_paguyuban_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
}

// ==========================================
// LAPORAN PDF DENGAN FORMAT REKENING KORAN
// ==========================================
function downloadReport() {
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF('p', 'mm', 'a4');
  
  var pageWidth = doc.internal.pageSize.getWidth();
  var margin = 15;
  var contentWidth = pageWidth - (margin * 2);
  
  // Header dengan border
  doc.setDrawColor(0);
  doc.setLineWidth(0.5);
  doc.rect(margin, 10, contentWidth, 30);
  
  // Logo (jika ada)
  var yPos = 18;
  if (appData.settings.logo) {
    try {
      doc.addImage(appData.settings.logo, 'JPEG', margin + 5, 12, 15, 15);
    } catch(e) {
      console.log('Logo error:', e);
    }
  }
  
  // Title
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  var title = appData.settings.nama || 'Paguyuban Simpan Pinjam';
  doc.text(title, pageWidth / 2, yPos, { align: 'center' });
  
  // Subtitle/Alamat
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  var subtitle = appData.settings.alamat || 'Politeknik Negeri Madura';
  doc.text(subtitle, pageWidth / 2, yPos + 5, { align: 'center' });
  
  // Filter info
  var filterText = [];
  if (filterLaporan.nama) filterText.push('Nama: ' + filterLaporan.nama);
  if (filterLaporan.tanggal) filterText.push('Tanggal: ' + filterLaporan.tanggal);
  if (filterLaporan.minggu) filterText.push('Minggu: ' + filterLaporan.minggu);
  if (filterLaporan.bulan) filterText.push('Bulan: ' + filterLaporan.bulan);
  if (filterLaporan.tahun) filterText.push('Tahun: ' + filterLaporan.tahun);
  
  var periode = filterText.length > 0 ? filterText.join(' | ') : 'Semua Periode';
  doc.text(periode, pageWidth / 2, yPos + 10, { align: 'center' });
  
  // Judul Laporan
  yPos = 48;
  doc.setFontSize(11);
  doc.setFont(undefined, 'bold');
  doc.text('Rekening Koran Dana Tampungan', pageWidth / 2, yPos, { align: 'center' });
  
  // Tabel Header
  yPos = 58;
  var colTanggal = margin;
  var colJenis = margin + 25;
  var colKeterangan = margin + 45;
  var colDebet = margin + 120;
  var colKredit = margin + 150;
  
  // Header background
  doc.setFillColor(220, 220, 220);
  doc.rect(margin, yPos - 5, contentWidth, 8, 'F');
  
  doc.setFontSize(9);
  doc.setFont(undefined, 'bold');
  doc.text('Tanggal', colTanggal, yPos);
  doc.text('Jenis', colJenis, yPos);
  doc.text('Keterangan', colKeterangan, yPos);
  doc.text('Debet', colDebet, yPos);
  doc.text('Kredit', colKredit, yPos);
  
  // Garis header
  yPos += 2;
  doc.line(margin, yPos, margin + contentWidth, yPos);
  
  // Kumpulkan data yang sama dengan preview
  var allTransaksi = [];
  
  // 1. Angsuran
  appData.angsuran.forEach(function(a) {
    var date = new Date(a.created_at);
    var include = true;
    
    if (filterLaporan.nama && a.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && a.created_at.split('T')[0] !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan) {
      var transBulan = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
      if (transBulan !== filterLaporan.bulan) include = false;
    }
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: a.created_at,
        jenis: 'ANGSURAN',
        keterangan: 'Angsuran ke-' + a.ke + ' - ' + a.anggota,
        nominal: a.nominal,
        tipe: 'DEBET'
      });
    }
  });
  
  // 2. Pencairan Pinjaman
  appData.pinjaman.forEach(function(p) {
    if (!p.tanggal) return;
    var date = new Date(p.tanggal);
    var include = true;
    
    if (filterLaporan.nama && p.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && p.tanggal !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan && p.tanggal.substring(0, 7) !== filterLaporan.bulan) include = false;
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: p.tanggal + 'T00:00:00.000Z',
        jenis: 'PENCAIRAN',
        keterangan: 'Pencairan Pinjaman - ' + p.anggota,
        nominal: p.nominal,
        tipe: 'KREDIT'
      });
    }
  });
  
  // 3. Iuran
  appData.iuran.forEach(function(i) {
    var date = new Date(i.created_at);
    var include = true;
    
    if (filterLaporan.nama && i.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && i.created_at.split('T')[0] !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan && i.bulan !== filterLaporan.bulan) include = false;
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: i.created_at,
        jenis: 'IURAN',
        keterangan: 'Iuran ' + i.bulan + ' - ' + i.anggota,
        nominal: i.nominal,
        tipe: 'DEBET'
      });
    }
  });
  
  // 4. Pengembalian Iuran
  appData.refund.forEach(function(r) {
    var date = new Date(r.tanggal);
    var include = true;
    
    if (filterLaporan.nama && r.anggota !== filterLaporan.nama) include = false;
    if (filterLaporan.tanggal && r.tanggal !== filterLaporan.tanggal) include = false;
    if (filterLaporan.minggu && getMingguKe(date) != filterLaporan.minggu) include = false;
    if (filterLaporan.bulan) {
      var refundBulan = r.tanggal.substring(0, 7);
      if (refundBulan !== filterLaporan.bulan) include = false;
    }
    if (filterLaporan.tahun && date.getFullYear() != filterLaporan.tahun) include = false;
    
    if (include) {
      allTransaksi.push({
        tanggal: r.tanggal + 'T00:00:00.000Z',
        jenis: 'PENGEMBALIAN',
        keterangan: 'Pengembalian Iuran - ' + r.anggota,
        nominal: r.nominal,
        tipe: 'KREDIT'
      });
    }
  });
  
  // Sort by tanggal
  allTransaksi.sort(function(a, b) {
    return new Date(a.tanggal) - new Date(b.tanggal);
  });
  
  // Isi transaksi
  yPos += 6;
  doc.setFont(undefined, 'normal');
  
  var totalDebet = 0;
  var totalKredit = 0;
  
  allTransaksi.forEach(function(t) {
    if (yPos > 270) {
      doc.addPage();
      yPos = 20;
    }
    
    if (t.tipe === 'DEBET') totalDebet += t.nominal;
    else totalKredit += t.nominal;
    
    doc.text(formatDate(new Date(t.tanggal)), colTanggal, yPos);
    doc.text(t.jenis, colJenis, yPos);
    doc.text(t.keterangan, colKeterangan, yPos);
    doc.text(t.tipe === 'DEBET' ? 'Rp ' + t.nominal.toLocaleString('id-ID') : '', colDebet, yPos);
    doc.text(t.tipe === 'KREDIT' ? 'Rp ' + t.nominal.toLocaleString('id-ID') : '', colKredit, yPos);
    
    yPos += 6;
  });
  
  // Garis penutup
  doc.line(margin, yPos, margin + contentWidth, yPos);
  yPos += 6;
  
  // Total
  doc.setFont(undefined, 'bold');
  doc.text('TOTAL', colKeterangan, yPos);
  doc.text('Rp ' + totalDebet.toLocaleString('id-ID'), colDebet, yPos);
  doc.text('Rp ' + totalKredit.toLocaleString('id-ID'), colKredit, yPos);
  
  // Footer
  doc.setFontSize(8);
  doc.setFont(undefined, 'normal');
  doc.text('Dicetak: ' + new Date().toLocaleString('id-ID'), margin, 285);
  doc.text('Created & Developed by D.D Candra', pageWidth - margin, 285, { align: 'right' });
  
  var filename = 'rekening_koran_' + (filterLaporan.bulan || new Date().toISOString().split('T')[0]) + '.pdf';
  doc.save(filename);
}

// Helper function
function formatDate(date) {
  var d = new Date(date);
  var day = d.getDate().toString().padStart(2, '0');
  var month = (d.getMonth() + 1).toString().padStart(2, '0');
  var year = d.getFullYear();
  return day + '-' + month + '-' + year;
}
</script>
</body>
</html>
